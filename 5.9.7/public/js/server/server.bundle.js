(function (global) {
  const console = {
    log: logger('LOG'),
    error: logger('ERROR'),
    info: logger('INFO'),
    time: function (timer) {
      this[timer] = new Date();
    },
    timeEnd: function (timer) {
      const delta = new Date() - this[timer];
      this.info(timer, delta, 'msec');
    },
  };
  function logger (NAME) {
    return function (...args) {
      print.apply(global, [NAME + ':'].concat(args));
    };
  }
  global.console = console;
})(this);
// https://github.com/fluffynuts/synchronous-promise
(function (global) {
  'use strict';
  const PENDING = 'pending';
  const RESOLVED = 'resolved';
  const REJECTED = 'rejected';

  function SynchronousPromise (handler) {
    this.status = PENDING;
    this._continuations = [];
    this._parent = null;
    this._paused = false;
    if (handler) {
      handler.call(
        this,
        this._continueWith.bind(this),
        this._failWith.bind(this),
      );
    }
  }

  function looksLikeAPromise (obj) {
    return obj && typeof (obj.then) === 'function';
  }

  SynchronousPromise.prototype = {
    then: function (nextFn, catchFn) {
      const next = SynchronousPromise.unresolved()._setParent(this);
      if (this._isRejected()) {
        if (this._paused) {
          this._continuations.push({
            promise: next,
            nextFn: nextFn,
            catchFn: catchFn,
          });
          return next;
        }
        if (catchFn) {
          try {
            const catchResult = catchFn(this._error);
            if (looksLikeAPromise(catchResult)) {
              this._chainPromiseData(catchResult, next);
              return next;
            } else {
              return SynchronousPromise.resolve(catchResult)._setParent(this);
            }
          } catch (e) {
            return SynchronousPromise.reject(e)._setParent(this);
          }
        }
        return SynchronousPromise.reject(this._error)._setParent(this);
      }
      this._continuations.push({
        promise: next,
        nextFn: nextFn,
        catchFn: catchFn,
      });
      this._runResolutions();
      return next;
    },
    catch: function (handler) {
      if (this._isResolved()) {
        return SynchronousPromise.resolve(this._data)._setParent(this);
      }
      const next = SynchronousPromise.unresolved()._setParent(this);
      this._continuations.push({
        promise: next,
        catchFn: handler,
      });
      this._runRejections();
      return next;
    },
    pause: function () {
      this._paused = true;
      return this;
    },
    resume: function () {
      const firstPaused = this._findFirstPaused();
      if (firstPaused) {
        firstPaused._paused = false;
        firstPaused._runResolutions();
        firstPaused._runRejections();
      }
      return this;
    },
    _findAncestry: function () {
      return this._continuations.reduce(function (acc, cur) {
        if (cur.promise) {
          const node = {
            promise: cur.promise,
            children: cur.promise._findAncestry(),
          };
          acc.push(node);
        }
        return acc;
      }, []);
    },
    _setParent: function (parent) {
      if (this._parent) {
        throw new Error('parent already set');
      }
      this._parent = parent;
      return this;
    },
    _continueWith: function (data) {
      const firstPending = this._findFirstPending();
      if (firstPending) {
        firstPending._data = data;
        firstPending._setResolved();
      }
    },
    _findFirstPending: function () {
      return this._findFirstAncestor(function (test) {
        return test._isPending && test._isPending();
      });
    },
    _findFirstPaused: function () {
      return this._findFirstAncestor(function (test) {
        return test._paused;
      });
    },
    _findFirstAncestor: function (matching) {
      let test = this;
      let result;
      while (test) {
        if (matching(test)) {
          result = test;
        }
        test = test._parent;
      }
      return result;
    },
    _failWith: function (error) {
      const firstRejected = this._findFirstPending();
      if (firstRejected) {
        firstRejected._error = error;
        firstRejected._setRejected();
      }
    },
    _takeContinuations: function () {
      return this._continuations.splice(0, this._continuations.length);
    },
    _runRejections: function () {
      if (this._paused || !this._isRejected()) {
        return;
      }
      const
        error = this._error;
      const continuations = this._takeContinuations();
      const self = this;
      continuations.forEach(function (cont) {
        if (cont.catchFn) {
          try {
            const catchResult = cont.catchFn(error);
            self._handleUserFunctionResult(catchResult, cont.promise);
          } catch (e) {
            cont.promise.reject(e);
          }
        } else {
          cont.promise.reject(error);
        }
      });
    },
    _runResolutions: function () {
      if (this._paused || !this._isResolved()) {
        return;
      }
      const continuations = this._takeContinuations();
      if (looksLikeAPromise(this._data)) {
        return this._handleWhenResolvedDataIsPromise(this._data);
      }
      const data = this._data;
      const self = this;
      continuations.forEach(function (cont) {
        if (cont.nextFn) {
          try {
            const result = cont.nextFn(data);
            self._handleUserFunctionResult(result, cont.promise);
          } catch (e) {
            self._handleResolutionError(e, cont);
          }
        } else if (cont.promise) {
          cont.promise.resolve(data);
        }
      });
    },
    _handleResolutionError: function (e, continuation) {
      this._setRejected();
      if (continuation.catchFn) {
        try {
          continuation.catchFn(e);
          return;
        } catch (e2) {
          e = e2;
        }
      }
      if (continuation.promise) {
        continuation.promise.reject(e);
      }
    },
    _handleWhenResolvedDataIsPromise: function (data) {
      const self = this;
      return data.then(function (result) {
        self._data = result;
        self._runResolutions();
      }).catch(function (error) {
        self._error = error;
        self._setRejected();
        self._runRejections();
      });
    },
    _handleUserFunctionResult: function (data, nextSynchronousPromise) {
      if (looksLikeAPromise(data)) {
        this._chainPromiseData(data, nextSynchronousPromise);
      } else {
        nextSynchronousPromise.resolve(data);
      }
    },
    _chainPromiseData: function (promiseData, nextSynchronousPromise) {
      promiseData.then(function (newData) {
        nextSynchronousPromise.resolve(newData);
      }).catch(function (newError) {
        nextSynchronousPromise.reject(newError);
      });
    },
    _setResolved: function () {
      this.status = RESOLVED;
      if (!this._paused) {
        this._runResolutions();
      }
    },
    _setRejected: function () {
      this.status = REJECTED;
      if (!this._paused) {
        this._runRejections();
      }
    },
    _isPending: function () {
      return this.status === PENDING;
    },
    _isResolved: function () {
      return this.status === RESOLVED;
    },
    _isRejected: function () {
      return this.status === REJECTED;
    },
  };

  SynchronousPromise.resolve = function (result) {
    return new SynchronousPromise(function (resolve, reject) {
      if (looksLikeAPromise(result)) {
        result.then(function (newResult) {
          resolve(newResult);
        }).catch(function (error) {
          reject(error);
        });
      } else {
        resolve(result);
      }
    });
  };

  SynchronousPromise.reject = function (result) {
    return new SynchronousPromise(function (resolve, reject) {
      reject(result);
    });
  };

  SynchronousPromise.unresolved = function () {
    return new SynchronousPromise(function (resolve, reject) {
      this.resolve = resolve;
      this.reject = reject;
    });
  };

  SynchronousPromise.all = function (...args) {
    if (Array.isArray(args[0])) {
      args = args[0];
    }
    if (!args.length) {
      return SynchronousPromise.resolve([]);
    }
    return new SynchronousPromise(function (resolve, reject) {
      const
        allData = [];
      let numResolved = 0;
      const doResolve = function () {
        if (numResolved === args.length) {
          resolve(allData);
        }
      };
      let rejected = false;
      const doReject = function (err) {
        if (rejected) {
          return;
        }
        rejected = true;
        reject(err);
      };
      args.forEach(function (arg, idx) {
        SynchronousPromise.resolve(arg).then(function (thisResult) {
          allData[idx] = thisResult;
          numResolved += 1;
          doResolve();
        }).catch(function (err) {
          doReject(err);
        });
      });
    });
  };

  if (Promise === SynchronousPromise) {
    throw new Error('Please use SynchronousPromise.installGlobally() to install globally');
  }
  const RealPromise = Promise;
  SynchronousPromise.installGlobally = function (__awaiter) {
    if (Promise === SynchronousPromise) {
      return __awaiter;
    }
    const result = patchAwaiterIfRequired(__awaiter);
    Promise = SynchronousPromise;
    return result;
  };

  SynchronousPromise.uninstallGlobally = function () {
    if (Promise === SynchronousPromise) {
      Promise = RealPromise;
    }
  };

  function patchAwaiterIfRequired (__awaiter) {
    if (typeof(__awaiter) === 'undefined' || __awaiter.__patched) {
      return __awaiter;
    }
    const originalAwaiter = __awaiter;
    __awaiter = function (...args) {
      originalAwaiter.apply(this, args);
    };
    __awaiter.__patched = true;
    return __awaiter;
  }

  global.Promise = SynchronousPromise;
})(this);
var veda=function(){"use strict";
/* Riot 1.0.4, @license MIT, (c) 2014 Muut Inc + contributors */const riot={observable:function(t){if(t.on&&t.one&&t.off&&t.trigger)return t;let e={};return t.on=function(i,r){return"function"==typeof r&&i.replace(/[^\s]+/g,(function(t,i){e[t]=e[t]||[],e[t].push(r),r.typed=i>0})),t},t.off=function(i,r){return"*"===i?e={}:r?i.replace(/[^\s]+/g,(function(t){e[t]&&(e[t]=e[t].filter((function(t){return t!==r})))})):i.replace(/[^\s]+/g,(function(t){e[t]=[]})),t},t.one=t.once=function(e,i){return i&&(i.one=!0),t.on(e,i)},t.trigger=t.emit=function(i,...r){const n=e[i]||[];let o=0;return n.reduce(((e,a,s)=>e.then((()=>(a.one&&(n.splice(s-o,1),o++),a.apply(t,a.typed?[i].concat(r):r))))),Promise.resolve()).then((()=>t))},t}},FN={},template_escape={"\\":"\\\\","\n":"\\n","\r":"\\r","'":"\\'"},render_escape={"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"};function default_escape_fn(t,e){return null==t?"":(t+"").replace(/[&\"<>]/g,(function(t){return render_escape[t]}))}riot.render=function(t,e,i){return!0===i&&(i=default_escape_fn),FN[t=t||""]=FN[t]||new Function("_","e","return '"+t.replace(/[\\\n\r']/g,(function(t){return template_escape[t]})).replace(/{\s*([\w\.]+)\s*}/g,"' + (e?e(_.$1,'$1'):_.$1||(_.$1==null?'':_.$1)) + '")+"'"),FN[t](e,i)},function(){if("undefined"==typeof window)return;const t=riot.observable({});function e(e){e=e.type?location.hash:e,t.trigger("pop",e)}(0,window.addEventListener)("popstate",e,!1),riot.route=function(i,r){if("function"==typeof i)return t.on("pop",i);history.pushState&&history.pushState(0,0,i),r||e(i)}}();const ServerBackend={status:"limited",get_rights:function(t,e,i){const r=t;"object"==typeof r&&(t=r.ticket,e=r.uri,i=r.user_id);try{const r=get_rights(t,e,i);return r?Promise.resolve(r):Promise.reject(Error("get_rights failed"))}catch(t){return Promise.reject(t)}},query:function(t,e,i,r,n,o,a){const s=t;"object"==typeof s&&(t=s.ticket,e=s.query,i=s.sort,r=s.databases,n=s.top,o=s.limit,a=s.from);try{return Promise.resolve(query(t,e,i,r,n,o,a))}catch(t){return Promise.reject(t)}},get_individual:function(t,e){const i=t;"object"==typeof i&&(t=i.ticket,e=i.uri);try{const i=get_individual(t,e);return i?Promise.resolve(i):Promise.reject(Error("Not found"))}catch(t){return Promise.reject(t)}},get_individuals:function(t,e){const i=t;"object"==typeof i&&(t=i.ticket,e=i.uris);try{return Promise.resolve(get_individuals(t,e))}catch(t){return Promise.reject(t)}},remove_individual:function(t,e){const i=t;"object"==typeof i&&(t=i.ticket,e=i.uri);try{return Promise.resolve(remove_individual(t,e))}catch(t){return Promise.reject(t)}},put_individual:function(t,e){const i=t;"object"==typeof i&&(t=i.ticket,e=i.individual);try{return Promise.resolve(put_individual(t,e))}catch(t){return Promise.reject(t)}},add_to_individual:function(t,e){const i=t;"object"==typeof i&&(t=i.ticket,e=i.individual);try{return Promise.resolve(add_to_individual(t,e))}catch(t){return Promise.reject(t)}},set_in_individual:function(t,e){const i=t;"object"==typeof i&&(t=i.ticket,e=i.individual);try{return Promise.resolve(set_in_individual(t,e))}catch(t){return Promise.reject(t)}},remove_from_individual:function(t,e){const i=t;"object"==typeof i&&(t=i.ticket,e=i.individual);try{return Promise.resolve(remove_from_individual(t,e))}catch(t){return Promise.reject(t)}}};class BackendError extends Error{constructor(t){const e=void 0!==t?`${BackendError.#t[t]}`:void 0;super(e),this.name="BackendError",this.code=t,this.message=e}toString(){return`${this.name} ${this.code}: ${this.message}`}static#t={0:"Server unavailable",400:"Bad request",403:"Forbidden",404:"Not found",422:"Unprocessable entity",423:"Locked",429:"Too many requests",430:"Too many password change fails",463:"Password change is not allowed",464:"Secret expired",465:"Empty password",466:"New password is equal to old",467:"Invalid password",468:"Invalid secret",469:"Password expired",470:"Ticket not found",471:"Ticket expired",472:"Not authorized",473:"Authentication failed",474:"Not ready",475:"Fail open transaction",476:"Fail commit",477:"Fail store",500:"Internal server error",501:"Not implemented",503:"Service unavailable",904:"Invalid identifier",999:"Database modified error",1021:"Disk full",1022:"Duplicate key",1118:"Size too large",4e3:"Connect error"}}class BrowserBackend{static async get_rights(t,e,i){const r=t,n="object"==typeof r;return call_server({method:"GET",url:"/get_rights",ticket:n?r.ticket:t,data:{uri:n?r.uri:e,user_id:n?r.user_id:i}})}static async get_rights_origin(t,e){const i=t,r="object"==typeof i;return call_server({method:"GET",url:"/get_rights_origin",ticket:r?i.ticket:t,data:{uri:r?i.uri:e}})}static async get_membership(t,e){const i=t,r="object"==typeof i;return call_server({method:"GET",url:"/get_membership",ticket:r?i.ticket:t,data:{uri:r?i.uri:e}})}static async authenticate(t,e,i){const r=t,n="object"==typeof r;return call_server({method:"POST",url:"/authenticate",data:{login:n?r.login:t,password:n?r.password:e,secret:n?r.secret:i}}).then(adjustTicket)}static async get_ticket_trusted(t,e){const i=t,r="object"==typeof i;return call_server({method:"GET",url:"/get_ticket_trusted",ticket:r?i.ticket:t,data:{login:r?i.login:e}}).then(adjustTicket)}static async is_ticket_valid(t){return call_server({method:"GET",url:"/is_ticket_valid",ticket:"object"==typeof t?t.ticket:t,data:{}})}static async logout(t){return call_server({method:"GET",url:"/logout",ticket:"object"==typeof t?t.ticket:t,data:{}})}static async get_operation_state(t,e){const i=t,r="object"==typeof i;return call_server({method:"GET",url:"/get_operation_state",data:{module_id:r?i.module_id:t,wait_op_id:r?i.wait_op_id:e}})}static async wait_module(t,e,i=10){if(!i)return Promise.resolve(!1);const r=t,n="object"==typeof r;return t=n?r.module_id:t,e=n?r.op_id:e,wait(250*(10-i)).then((()=>BrowserBackend.get_operation_state(t,e))).then((r=>!(r<e)||BrowserBackend.wait_module(t,e,--i)))}static async query(t,e,i,r,n,o,a,s,l=10){if(!l)throw new BackendError(429);const c=t,u="object"==typeof c;return call_server({method:"POST",url:"/query",ticket:u?c.ticket:t,data:{query:u?c.query:e,sort:u?c.sort:i,databases:u?c.databases:r,top:u?c.top:n,limit:u?c.limit:o,from:u?c.from:a,sql:u?c.sql:s}}).catch((c=>{if(999===c.code)return wait().then((()=>BrowserBackend.query(t,e,i,r,n,o,a,s,--l)));throw c}))}static async get_individual(t,e,i=!0){const r=t,n="object"==typeof r;return call_server({method:"GET",url:"/get_individual",ticket:n?r.ticket:t,data:{uri:n?r.uri:e,...!i&&{vsn:Date.now()}}})}static async get_individuals(t,e){const i=t,r="object"==typeof i;return call_server({method:"POST",url:"/get_individuals",ticket:r?i.ticket:t,data:{uris:r?i.uris:e}})}static async remove_individual(t,e,i,r,n){const o=t,a="object"==typeof o;return call_server({method:"PUT",url:"/remove_individual",ticket:a?o.ticket:t,data:{uri:a?o.uri:e,assigned_subsystems:(a?o.assigned_subsystems:i)||0,prepare_events:!0,event_id:(a?o.event_id:r)||"",transaction_id:(a?o.transaction_id:n)||""}})}static async put_individual(t,e,i,r,n){const o=t,a="object"==typeof o;return call_server({method:"PUT",url:"/put_individual",ticket:a?o.ticket:t,data:{individual:a?o.individual:e,assigned_subsystems:(a?o.assigned_subsystems:i)||0,prepare_events:!0,event_id:(a?o.event_id:r)||"",transaction_id:(a?o.transaction_id:n)||""}})}static async add_to_individual(t,e,i,r,n){const o=t,a="object"==typeof o;return call_server({method:"PUT",url:"/add_to_individual",ticket:a?o.ticket:t,data:{individual:a?o.individual:e,assigned_subsystems:(a?o.assigned_subsystems:i)||0,prepare_events:!0,event_id:(a?o.event_id:r)||"",transaction_id:(a?o.transaction_id:n)||""}})}static async set_in_individual(t,e,i,r,n){const o=t,a="object"==typeof o;return call_server({method:"PUT",url:"/set_in_individual",ticket:a?o.ticket:t,data:{individual:a?o.individual:e,assigned_subsystems:(a?o.assigned_subsystems:i)||0,prepare_events:!0,event_id:(a?o.event_id:r)||"",transaction_id:(a?o.transaction_id:n)||""}})}static async remove_from_individual(t,e,i,r,n){const o=t,a="object"==typeof o;return call_server({method:"PUT",url:"/remove_from_individual",ticket:a?o.ticket:t,data:{individual:a?o.individual:e,assigned_subsystems:(a?o.assigned_subsystems:i)||0,prepare_events:!0,event_id:(a?o.event_id:r)||"",transaction_id:(a?o.transaction_id:n)||""}})}static async put_individuals(t,e,i,r,n){const o=t,a="object"==typeof o;return call_server({method:"PUT",url:"/put_individuals",ticket:a?o.ticket:t,data:{individuals:a?o.individuals:e,assigned_subsystems:(a?o.assigned_subsystems:i)||0,prepare_events:!0,event_id:(a?o.event_id:r)||"",transaction_id:(a?o.transaction_id:n)||""}})}}async function call_server(t){const e=new URL(t.url,location.origin);"GET"===t.method&&(t.data=t.data&&Object.entries(t.data).filter((([t,e])=>void 0!==e))||"",e.search=new URLSearchParams(t.data).toString()),t.ticket&&e.searchParams.append("ticket",t.ticket);const i=await fetch(e,{method:t.method,mode:"same-origin",cache:"no-cache",credentials:"same-origin",..."GET"!==t.method&&{headers:{"Content-Type":"application/json"},body:JSON.stringify(t.data)}});if(i.ok)return i.json();throw new BackendError(i.status)}function wait(t=1e3){return new Promise((e=>setTimeout(e,t)))}function adjustTicket(t){return{ticket:t.id,user_uri:t.user_uri,end_time:Math.floor((t.end_time-621355968e9)/1e4)}}var Backend="undefined"==typeof window&&"undefined"==typeof process?ServerBackend:BrowserBackend;class UpdateService{constructor(t){if(UpdateService.prototype._singletonInstance)return UpdateService.prototype._singletonInstance;riot.observable(this),this.subscriptions=new Map,this.registry=new FinalizationRegistry((t=>{this.unsubscribe(t)})),this.onLine=!1,UpdateService.prototype._singletonInstance=this}async start(){if(this.started)return Promise.resolve(this);this.started=!0,this.stopped=!1;const t=this,e=1e4+Math.floor(5e4*Math.random()),i=1.25,r=3e5,n=1e4,o=[],a=1e3;let s,l,c=e,u=Date.now();try{const t=await Backend.get_individual("","cfg:ClientUpdateServiceAddress",!1);this.address=t["rdf:value"]&&t["rdf:value"][0].data,this.url=new URL(this.address)}catch(t){console.log(`CCUS address error, address = ${this.address}, url = ${this.url}`,t),this.url=new URL(`${"https:"===location.protocol?"wss:":"ws:"}//${location.host}${this.address}`)}try{const d=new WebSocket(this.url);d.onopen=function(i){c=e,console.log("client: websocket opened",i.target.url),this.sendMessage("ccus="+veda$1.ticket),t.restore(),t.onLine=!0,t.trigger("online"),l=setInterval((()=>{Date.now()-u>2*n&&(console.log("client: ping missed, close socket"),t.onLine=!1,t.trigger("offline"),clearInterval(l),this.close())}),n)},d.onclose=function(e){console.log("client: websocket closed",e.target.url),t.socket=null,t.onLine=!1,t.started=!1,t.trigger("offline"),clearInterval(l),t.stopped||(c=c<r?c*i:r,console.log("client: re-connect in",c/1e3,"sec"),setTimeout(t.start.bind(t),c))},d.onerror=function(t){console.error("CCUS failed",t),this.close()},d.onmessage=function(t){const e=t.data;this.receiveMessage(e)},d.receiveMessage=function(e){if(""===e)return void(u=Date.now());let i=0===e.indexOf("=")?e.substr(1):e;if(0===i.length)return;i=i.split(",");for(const e of i)try{const i=e.split("="),[r,n]=i;if(!r)continue;const o=t.subscriptions.get(r);if(o){const[t]=o.slice(-1);t(r,Number(n))}else t.unsubscribe(r)}catch(t){console.error("Individual update service failed")}},d.sendMessage=function(t){const e=this;if("="===t||"-*"===t||0===t.indexOf("ccus"))return void(1===e.readyState&&e.send(t));o.push(t),s||(s=setTimeout((()=>{if(1===e.readyState)for(;o.length;){const t=o.splice(0,100).join(",");e.send(t)}s=void 0}),a))},this.socket=d}catch(t){this.started=!1,c=c<r?c*i:r,console.error("Init socket failed, retry in",c/1e3,"sec"),setTimeout(this.start.bind(this),c)}}stop(){this.stopped=!0,this.socket.close()}subscribe(t,e){const[i,r]=e;this.subscriptions.has(i)||(this.subscriptions.set(i,e),this.registry.register(t,i),this.socket&&this.socket.sendMessage(`+${i}=${r||0}`))}unsubscribe(t){t?(this.subscriptions.delete(t),this.socket&&this.socket.sendMessage("-"+t)):(this.subscriptions.clear(),this.socket.sendMessage("-*"))}restore(){if(this.socket.sendMessage("-*"),this.socket)for(const[t,e]of this.subscriptions.values())this.socket.sendMessage(`+${t}=${e||0}`)}}class WeakCache{constructor(){this.storage=new Map}has(t){if(this.storage.has(t)){return!!this.storage.get(t).deref()||(this.storage.delete(t),!1)}return!1}get(t){if(this.storage.has(t)){const e=this.storage.get(t).deref();if(e)return e;this.storage.delete(t)}}set(t,e){this.storage.set(t,new WeakRef(e))}delete(t){this.storage.delete(t)}clear(){this.storage.clear()}keys(){return this.storage.keys()}}const Util$1={};function zeroPref(t){return t>9?String(t):"0"+t}function formatString(t){return!t.language||"NONE"===t.language||veda$1.user&&veda$1.user.preferences&&veda$1.user.preferences.language&&t.language in veda$1.user.preferences.language?t:void 0}function formatDate(t){const e=t.getDate(),i=t.getMonth()+1,r=t.getFullYear(),n=t.getHours(),o=t.getMinutes(),a=t.getSeconds();if(t.getUTCHours()+t.getUTCMinutes()+t.getUTCSeconds()===0)return[zeroPref(e),zeroPref(i),r].join(".");let s=[zeroPref(e),zeroPref(i),r].join(".");"01.01.1970"===s&&(s="");let l=[zeroPref(n),zeroPref(o),zeroPref(a)].join(":");return"00:00:00"===l?l="":0===a&&(l=l.substring(0,5)),[s,l].join(" ")}function formatNumber(t){return Number(t).toLocaleString("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:20}).replace(/\s/g," ")}function flattenIndividual(t,e,i,r){const n=t["@"];if(i=void 0!==i?i:{},e=void 0!==e?e:"",!((r=void 0!==r?r:[]).indexOf(n)>-1)){r.push(n);for(const n in t){if("@"===n)continue;const o=t[n],a=e?e+"."+n:n;for(const t of o)if("Uri"===t.type){const e=new IndividualModel(t.data);e.isNew()?flattenIndividual(e.properties,a,i,r):(i[a]=i[a]?i[a]:[],i[a].push(t))}else i[a]=i[a]?i[a]:[],i[a].push(t)}return i}}let updateService;function IndividualModel(t,e=!0,i=!0){if("object"!=typeof t||t["@"]||(e=t.cache,i=t.init,t=t.uri),this._={cache:e,init:i},this.removedObjs=[],"object"==typeof t?(this.properties={...t},this.original=JSON.stringify(this.properties),this.isNew(!1),this.isLoaded(!0),this.isSync(!0)):"string"==typeof t?(this.properties={},this.original=JSON.stringify(this.properties),this.id=t,this.isNew(!1),this.isLoaded(!1),this.isSync(!1)):void 0===t&&(this.properties={},this.original=JSON.stringify(this.properties),this.id=Util$1.genUri(),this.isNew(!0),this.isLoaded(!1),this.isSync(!1)),e){const e=IndividualModel.cache.get(this.id);if(e)return"object"==typeof t&&(e._=this._,e.properties=this.properties,e.original=this.original),e;IndividualModel.cache.set(this.id,this)}return riot.observable(this),this.on("rdf:type",this.init),this.on("beforeSave",beforeSaveHandler),this}function beforeSaveHandler(){const t=new Date,e=veda$1.appointment?veda$1.appointment:veda$1.user;this.hasValue("v-s:creator")||this.set("v-s:creator",[e]),this.hasValue("v-s:created")||this.set("v-s:created",[t]),"cfg:Administrator"!==veda$1.user.id&&(!this.hasValue("v-s:lastEditor")||!this.hasValue("v-s:edited")||this.get("v-s:lastEditor")[0].id!==e.id||t-this.get("v-s:edited")[0]>1e3)&&(this.set("v-s:edited",[t]),this.set("v-s:lastEditor",[e]))}Util$1.mergeMutualChanges=function(t,e,i){let r;const n={};for(r in i)Object.hasOwnProperty.call(i,r)&&(n[r]=i[r]);const o=Util$1.diff(t,i),a=Util$1.diff(e,i),s=Util$1.diff(t,e),l=Util$1.diff(e,t);for(r in a.missing)Object.hasOwnProperty.call(a.missing,r)&&delete n[r];for(r in o.missing)Object.hasOwnProperty.call(o.missing,r)&&delete n[r];for(r in a.added)Object.hasOwnProperty.call(a.added,r)&&(n[r]=a.added[r]);for(r in o.added)Object.hasOwnProperty.call(o.added,r)&&(n[r]=o.added[r]);for(r in a.differ)Object.hasOwnProperty.call(a.differ,r)&&(n[r]=a.differ[r]);for(r in o.diff)Object.hasOwnProperty.call(o.diff,r)&&(n[r]=o.differ[r]);return{merged:n,conflicts:{high:s.differ,low:l.differ}}},Util$1.diff=function(t,e){const i={added:{},missing:{},differ:{}};let r,n,o,a,s,l;for(r in e)if(r in t){if("@"===r){t[r]!==e[r]&&(i.differ[r]=t[r]);continue}for(n=e[r],a=n.length,l=a===t[r].length,s=0;s<a&&l;s++)o=n[s],l=l&&Util$1.hasValue(t,r,o);l||(i.differ[r]=t[r])}else i.missing[r]=e[r];for(r in t)r in e||(i.added[r]=t[r]);return i},Util$1.hasValue=function(t,e,i){const r=!!(t&&t[e]&&t[e].length);return i?!(!r||!t[e].filter((t=>t.type===i.type&&t.data.valueOf()===i.data.valueOf())).length):r},Util$1.toJson=function(t){return JSON.stringify(t,null,2)},Util$1.processQuery=function(t,e,i,r,n,o,a,s){const l=function(f){const p=f||0;Backend.query({ticket:veda$1.ticket,query:t,sql:e,sort:i||"'v-s:created' desc",from:p,top:n,limit:r}).then((t=>{const e=t.cursor,i=t.estimated;r>i&&(r=i),u.apply(c,t.result),e/r-d>=.05&&(d=e/r,console.log("Fetching progress:",Math.floor(100*d)+"%","("+e,"of",r+")")),e===i||e>=r?(console.log((new Date).toString(),"Fetching done:",r),console.timeEnd("Fetching total"),c.splice(r-e||r),Util$1.processResult(c,o,a,s)):l(t.cursor)}))};"object"==typeof t&&(i=t.sort,r=t.limit,n=t.queryDelta,o=t.processDelta,a=t.pause,s=t.fn,e=t.sql,t=t.vql),console.log((new Date).toISOString(),"Process query results |||","query:",t||e," | ","limit:",r," | ","query delta:",n," | ","process delta:",o," | ","pause:",a);const c=[],u=[].push;let d=0;console.time("Fetching total"),l()},Util$1.processResult=function(t,e,i,r){const n=function(){t.splice(0,e).reduce(((t,e)=>t.then((()=>r(e))).catch((t=>{console.error("Error processing item:",e)}))),Promise.resolve()).then((()=>{(o-t.length)/o-a>=.05&&(a=(o-t.length)/o,console.log("Processing progress:",Math.floor(100*a)+"%","("+(o-t.length),"of",o+")")),t.length?setTimeout?setTimeout(n,i):n():(console.log("Processing done:",o),console.timeEnd("Processing total"))}))},o=t.length;let a=0;console.log((new Date).toISOString(),"Process results |||","total:",o," | ","delta:",e," | ","pause:",i),console.time("Processing total"),n()},Util$1.genUri=function(){const t=Util$1.guid();return/^\d/.test(t)?"d:a"+t:"d:"+t},Util$1.guid=function(){let t=(new Date).getTime();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(t+=performance.now()),"xxxxxxxxxxxxxxxxxxxxxxxxxx".replace(/x/g,(function(e){const i=(t+36*Math.random())%36|0;return t=Math.floor(t/36),i.toString(36)}))},Util$1.isInteger=function(t){return t%1==0},Util$1.formatValue=function(t){let e;switch(!0){case t instanceof Date:e=formatDate(t);break;case t instanceof Number:case"number"==typeof t:e=formatNumber(t);break;case t instanceof String:case"string"==typeof t:e=formatString(t);break;default:e=void 0!==t?t.toString():t}return e},Util$1.flatten=function(t,e){const i=Object.prototype.toString,r=[],n=e&&t||t.slice();let o;if(!t.length)return r;o=n.pop();do{"[object Array]"===i.call(o)?n.push(...o):r.push(o)}while(n.length&&void 0!==(o=n.pop()));return r.reverse(),r},Util$1.unique=function(t){const e={},i=[];for(const r of t)e[r]||(e[r]=!0,i.push(r));return i},Number.isFinite=Number.isFinite||function(t){return"number"==typeof t&&isFinite(t)},Number.isInteger=Number.isInteger||function(t){return"number"==typeof t&&Number.isFinite(t)&&!(t%1)},Number.isFloat=Number.isFloat||function(t){return"number"==typeof t&&Number.isFinite(t)&&t%1},Util$1.queryFromIndividualPT=function(t,e){const i=/[^a-zA-Z0-9]/g;try{let r=function(){const e=[];let i=-1;const r=Object.keys(t.properties).map((r=>{if(r.indexOf(".")>=0||r.indexOf("*")>=0)throw new Error("VQL style property nesting: "+r);if("@"===r)return;i++;const n="veda_pt.`"+r+"` as p"+i;e[i]=n;const o=t.get(r).sort(((t,e)=>t<e?-1:t===e?0:1));let a;switch(!0){case Number.isInteger(o[0]):a="p"+i+".int[1] >= "+o[0]+" AND p"+i+".int[1] <= "+o[o.length-1];break;case Number.isFloat(o[0]):a="p"+i+".dec[1] >= "+o[0]+" AND p"+i+".dec[1] <= "+o[o.length-1];break;case o[0]instanceof Date:let t=new Date(o[0]),e=new Date(o[o.length-1]);t.setHours(0,0,0,0),e.setHours(23,59,59,999),t=Math.floor(t.valueOf()/1e3),e=Math.floor(e.valueOf()/1e3),a="p"+i+".date[1] >= toDateTime("+t+") AND p"+i+".date[1] <= toDateTime("+e+")";break;case"boolean"==typeof o[0]:a=o.map((t=>"p"+i+".int[1] = "+(t?1:0))).join(" OR ");break;case o[0]instanceof String:a=o.filter(Boolean).map((t=>t.trim().split("\n").map((t=>{const e=t.trim().replace(/[-*\s]+/g," ").split(" ");return e.length&&"arrayStringConcat(p"+i+".str, ' ') LIKE '%"+e.join("% %").replace(/\'/g,"\\'").replace(/\"/g,"'")+"%'"})).filter(Boolean).join(" OR "))).filter(Boolean).join(" OR ");break;case o[0]instanceof IndividualModel:a=o.filter(Boolean).map((t=>t.isNew()?void 0:"has(p"+i+".str, '"+t.id+"')")).filter(Boolean).join(" OR ")}return a?a.indexOf(" OR ")>0?"( "+a+" )":a:void 0})).filter(Boolean).join(" AND ");return"SELECT DISTINCT id FROM "+e.reduce(((t,e,i)=>t?t+" JOIN "+e+" ON p"+(i-1)+".id = p"+i+".id":e),"")+(r?" WHERE "+r:"")}();const n=function(){if("string"==typeof e||e instanceof String)return e.replace(/'(.+?)'\s+(\w+)/gi,(function(t,e,r){const n=veda$1.ontology.properties[e].get("rdfs:range")[0],o=e.replace(i,"_");let a;switch(n.id){case"xsd:dateTime":a=o+".date "+r;break;case"xsd:boolean":case"xsd:integer":a=o+".int "+r;break;case"xsd:decimal":a=o+".dec "+r;break;default:a=o+".str "+r}return a}))}();return r=r&&n?r+" ORDER BY "+n:r,r}catch(t){console.error("Error building query")}},Util$1.queryFromIndividualTT_SUB=function(t,e,i){const r=function(t){if(t.id in visited)return;visited[t.id]=!0;let e=Object.keys(t.properties).map(((e,i)=>{if(e.indexOf(".")>=0||e.indexOf("*")>=0)throw new Error("VQL style property nesting: "+e);if("@"===e||"rdf:type"===e)return;const n=t.get(e).sort(((t,e)=>t<e?-1:t===e?0:1));let o,a=e.replace(re,"_");switch(!0){case Number.isInteger(n[0]):o=a+"_int[1] >= "+n[0]+" AND "+a+"_int[1] <= "+n[n.length-1];break;case Number.isFloat(n[0]):o=a+"_dec[1] >= "+n[0]+" AND "+a+"_dec[1] <= "+n[n.length-1];break;case n[0]instanceof Date:let t=new Date(n[0]),e=new Date(n[n.length-1]);t.setHours(0,0,0,0),e.setHours(23,59,59,999),t=Math.floor(t.valueOf()/1e3),e=Math.floor(e.valueOf()/1e3),o=a+"_date[1] >= toDateTime("+t+") AND "+a+"_date[1] <= toDateTime("+e+")";break;case"boolean"==typeof n[0]:o=n.map((t=>a+"_int[1] = "+(t?1:0))).join(" OR ");break;case n[0]instanceof String:o=n.filter(Boolean).map((t=>t.trim().split("\n").map((t=>{const e=t.trim().replace(/[-*\s]+/g," ").split(" ");return/\.\*$/.test(a)&&(a=a.replace("*","text")),/\.text$/.test(a)?e.length&&a+" LIKE '%"+e.join("% %").replace(/\'/g,"\\'").replace(/\"/g,"'")+"%'":e.length&&"lowerUTF8(arrayStringConcat("+a+"_str, ' ')) LIKE lowerUTF8('%"+e.join("% %").replace(/\'/g,"\\'").replace(/\"/g,"'")+"%')"})).filter(Boolean).join(" OR "))).filter(Boolean).join(" OR ");break;case n[0]instanceof IndividualModel:o=n.filter(Boolean).map((t=>{if(t.isNew()){const e=r(t);return e?a+"_str IN ( "+e+" )":void 0}return"has("+a+"_str, '"+t+"')"})).filter(Boolean).join(" OR ")}return o?o.indexOf(" OR ")>0?"( "+o+" )":o:void 0})).filter(Boolean).join(" AND ");return i||(e+=e?" AND ":"",e+="NOT v_s_deleted_int = [1]"),Object.keys(visited).length>1&&!e?void 0:t.get("rdf:type").map((t=>"SELECT id FROM "+("veda_tt.`"+t.id+"`")+(e?" WHERE "+e:""))).filter(Boolean).join(" UNION ALL ")};try{let i=r(t);const n=function(t){let e;return("string"==typeof t||t instanceof String)&&(e=t.replace(/'(.+?)'\s+(\w+)/gi,(function(t,e){const i=veda$1.ontology.properties[e].get("rdfs:range")[0];let r=e.replace(re,"_");switch(i.id){case"xsd:dateTime":r+="_date";break;case"xsd:boolean":case"xsd:integer":r+="_int";break;case"xsd:decimal":r+="_dec";break;default:r+="_str"}return r}))),e?"id, "+e:"id"}(e);i=i&&n?i+" GROUP BY "+n:i;const o=function(t){if("string"==typeof t||t instanceof String)return t.replace(/'(.+?)'\s+(\w+)/gi,(function(t,e,i){const r=veda$1.ontology.properties[e].get("rdfs:range")[0],n=e.replace(re,"_");let o;switch(r.id){case"xsd:dateTime":o=n+"_date "+i;break;case"xsd:boolean":case"xsd:integer":o=n+"_int "+i;break;case"xsd:decimal":o=n+"_dec "+i;break;default:o=n+"_str "+i}return o}))}(e);return i=i?i+" HAVING sum(sign) > 0":i,i=i&&o?i+" ORDER BY "+o:i,i}catch(t){console.error("Error building query")}},Util$1.queryFromIndividualTT_JOIN=function(t,e,i){let r=0;const n=/[^a-zA-Z0-9]/g;try{return t["rdf:type"].map(((o,a)=>{let s="",l="";const c=c||{};!function t(e,o,a){if(!e.hasValue("rdf:type"))return;r++,a=a||0;const u=e.get("rdf:type")[a].id,d="t"+r;c[e.id]=d;const f="veda_tt.`"+u+"` AS "+d;s+=o?" JOIN "+f+" ON "+o+" = ["+d+".id]":f;i||(l+=l?" AND ":"",l+="NOT "+d+".v_s_deleted_int = [1]");const p=Object.keys(e.properties).map(((i,r)=>{if(i.indexOf(".")>=0||i.indexOf("*")>=0)throw new Error("VQL style property nesting: "+i);if("@"===i||"rdf:type"===i)return;const o=e.get(i).sort(((t,e)=>t<e?-1:t===e?0:1));let a,s=d+"."+i.replace(n,"_");switch(!0){case Number.isInteger(o[0]):a=s+"_int[1] >= "+o[0]+" AND "+s+"_int[1] <= "+o[o.length-1];break;case Number.isFloat(o[0]):a=s+"_dec[1] >= "+o[0]+" AND "+s+"_dec[1] <= "+o[o.length-1];break;case o[0]instanceof Date:let e=new Date(o[0]),i=new Date(o[o.length-1]);e.setHours(0,0,0,0),i.setHours(23,59,59,999),e=Math.floor(e.valueOf()/1e3),i=Math.floor(i.valueOf()/1e3),a=s+"_date[1] >= toDateTime("+e+") AND "+s+"_date[1] <= toDateTime("+i+")";break;case"boolean"==typeof o[0]:a=o.map((t=>s+"_int[1] = "+(t?1:0))).join(" OR ");break;case o[0]instanceof String:a=o.filter(Boolean).map((t=>t.trim().split("\n").map((t=>{const e=t.trim().replace(/[-*\s]+/g," ").split(" ");return/\.\*$/.test(s)&&(s=s.replace("*","text")),/\.text$/.test(s)?e.length&&s+" LIKE '%"+e.join("% %").replace(/\'/g,"\\'").replace(/\"/g,"'")+"%'":e.length&&"lowerUTF8(arrayStringConcat("+s+"_str, ' ')) LIKE lowerUTF8('%"+e.join("% %").replace(/\'/g,"\\'").replace(/\"/g,"'")+"%')"})).filter(Boolean).join(" OR "))).filter(Boolean).join(" OR ");break;case o[0]instanceof IndividualModel:a=o.filter(Boolean).map((e=>e.isNew()&&!(e.id in c)?t(e,s+"_str"):e.isNew()&&e.id in c?"has("+s+"_str, "+c[e.id]+".id)":"has("+s+"_str, '"+e+"')")).filter(Boolean).join(" OR ")}return a?a.indexOf(" OR ")>0?"( "+a+" )":a:void 0})).filter(Boolean).join(" AND ");if(!p)return;l?l+=" AND "+p:l=p}(t,void 0,a);let u=s?"SELECT t1.id FROM "+s:"";u=u&&l?u+" WHERE "+l:u;const d=function(t){const e="t1.id";let i;("string"==typeof t||t instanceof String)&&(i=t.replace(/'(.+?)'\s+(\w+)/gi,(function(t,e){const i=veda$1.ontology.properties[e].get("rdfs:range")[0];let r=e.replace(n,"_");switch(i.id){case"xsd:dateTime":r+="_date";break;case"xsd:boolean":case"xsd:integer":r+="_int";break;case"xsd:decimal":r+="_dec";break;default:r+="_str"}return"t1."+r})));return i?e+", "+i:e}(e);u=u&&d?u+" GROUP BY "+d:u;const f=function(t){if("string"==typeof t||t instanceof String)return t.replace(/'(.+?)'\s+(\w+)/gi,(function(t,e,i){const r=veda$1.ontology.properties[e].get("rdfs:range")[0],o=e.replace(n,"_");let a;switch(r.id){case"xsd:dateTime":a=o+"_date "+i;break;case"xsd:boolean":case"xsd:integer":a=o+"_int "+i;break;case"xsd:decimal":a=o+"_dec "+i;break;default:a=o+"_str "+i}return"t1."+a}))}(e);return u=u?u+" HAVING sum(t1.sign) > 0":u,u=u&&f?u+" ORDER BY "+f:u,u})).join(" UNION ALL ")}catch(t){console.error("Error building query")}},Util$1.queryFromIndividual=function(t){const e=flattenIndividual(t.properties);if(t.hasValue("*")&&t.get("*")[0].indexOf("==")>0)return t.get("*")[0];const i=Object.getOwnPropertyNames(e).map((t=>{if("@"===t||"v-s:isDraft"===t)return;const i=e[t].sort(((t,e)=>t.data<e.data?-1:t.data===e.data?0:1));let r;switch(i[0].type){case"Integer":case"Decimal":r="'"+t+"'==["+i[0].data+","+i[i.length-1].data+"]";break;case"Datetime":const e=new Date(i[0].data),n=new Date(i[i.length-1].data);e.setHours(0,0,0,0),n.setHours(23,59,59,999),r="'"+t+"'==["+e.toISOString()+","+n.toISOString()+"]";break;case"Boolean":r=i.map((e=>"'"+t+"'=='"+e.data+"'")).join(" || ");break;case"String":r=i.filter((t=>!!t&&!!t.valueOf())).map((e=>{const i=e.data;if(i.match(/[\+\-\*]/))return"'"+t+"'=='"+i+"'";return i.trim().split("\n").map((e=>{const i=e.trim().replace(/[-*\s'"]+/g," ").split(" ").filter(Boolean);return e=i.map((t=>"+"+t+"*")).join(" "),"'"+t+"'=='"+e+"'"})).join(" || ")})).join(" || ");break;case"Uri":r=i.filter((t=>!!t&&!!t.valueOf())).map((e=>"'"+t+"'=='"+e.data+"'")).join(" || ")}return r?"( "+r+" )":void 0})).filter((t=>void 0!==t)).join(" && ");return i?"( "+i+" )":void 0},Util$1.complexLabel=function(t){t=t.properties||t;const e={};e[t["@"]]=t;const i=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.*Z$/i,r=function(t){return e[t]||(e[t]=get_individual(veda$1.ticket,t)),e[t]},n=function(t,e,...n){const o=r(e);if(!o)return"";let a=[o];for(let e=0;e<n.length;e++){const o=n[e];if(e===n.length-1){const e=[];return a.forEach((r=>{if(r[o]){const n=r[o].reduce(((e,r)=>{if(!r.lang||"NONE"===r.lang||r.lang.toLowerCase()===t.toLowerCase()){let t=r.data;(t instanceof Date||i.test(t))&&(t=new Date(t),t=new Date(t.getTime()-6e4*t.getTimezoneOffset()).toISOString().substring(0,10)),e+=t}return e}),"");e.push(n)}})),e.join(", ")}const s=[];if(a.forEach((t=>{Util$1.hasValue(t,o)&&t[o].forEach((t=>{s.push(r(t.data))}))})),!s.length)return"";a=s}return""};try{const e=r("v-ui:AvailableLanguage")["rdf:value"].map((t=>{const e=t.data;return r(e)["rdf:value"][0].data}));return t["rdf:type"].reduce(((i,o)=>{const a=o.data,s=r(a);if(!s||!Util$1.hasValue(s,"v-s:labelPattern"))return i;const l=s["v-s:labelPattern"][0].data;return e.forEach((e=>{const r={data:l.replace(/{(\s*([^{}]+)\s*)}/g,(function(i,r){let o=null;if(-1!=r.indexOf(" ")){const t=r.split(" ");r=t[0],o=t[1].substring(1,t[1].length-1).split(",")}const a=r.split(".");"@"===a[0]&&(a[0]=t["@"]);const s=n.apply({},[e].concat(a));return null==o?s:s.substring(+o[0],+o[1])})),lang:e,type:"String"};i.push(r)})),i}),[])}catch(t){return console.error("Complex label failed"),[]}},Util$1.areEqual=function(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i)){if(!Object.prototype.hasOwnProperty.call(e,i))return!1;if(t[i]!==e[i]){if("object"!=typeof t[i])return!1;if(!Util$1.areEqual(t[i],e[i]))return!1}}for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i)&&!Object.prototype.hasOwnProperty.call(t,i))return!1;return!0},"undefined"!=typeof window&&(updateService=new UpdateService,updateService.start()),IndividualModel.cache=new WeakCache;const proto$2=IndividualModel.prototype;function unique(t){const e={},i=[];for(let r,n=0;n<t.length;n++)r=t[n].type+t[n].data+(t[n].lang||""),e[r]||(e[r]=!0,i.push(t[n]));return i}function parser(t){if("String"===t.type&&t.data){const e=new String(t.data);return t.lang&&"NONE"!==t.lang&&(e.language=t.lang),e}return"Uri"===t.type?new IndividualModel(t.data):"Datetime"===t.type?new Date(Date.parse(t.data)):"Decimal"===t.type?parseFloat(t.data):"Integer"===t.type?parseInt(t.data):"Boolean"===t.type?Boolean(t.data):void 0}proto$2.get=function(t){return this.properties[t]?this.properties[t].map(parser).filter((t=>void 0!==t)):[]},proto$2.set=function(t,e,i){Array.isArray(e)||(e=[e]);const r=unique(e.map(serializer).filter(Boolean)),n=null==this.properties[t]?[]:this.properties[t];let o=!1;if(r.length!==n.length)o=!0;else for(const t of r){if(!n.some((function(e){return e.data==t.data&&e.type==t.type}))){o=!0;break}}return o&&(this.isSync(!1),r.length?this.properties[t]=r:delete this.properties[t],!i)?(e=this.get(t),this.trigger("propertyModified",t,e).then((()=>this.trigger(t,e)))):Promise.resolve(this)},IndividualModel.defineProperty=function(t){Object.defineProperty(proto$2,t,{get:function(){return this.get(t)},set:function(e){this.set(t,e)},configurable:!1,enumerable:!1})};const reg_uri=/^[a-z][a-z-0-9]*:([a-zA-Z0-9-_\.])*$/,reg_date=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?Z$/,reg_ml_string=/^(.*)\^([a-z]{2})$/ims,reg_round_decimal=/^-?\d+([\.\,])0$/;function serializer(t){if("number"==typeof t)return{type:Util$1.isInteger(t)?"Integer":"Decimal",data:t};if("boolean"==typeof t)return{type:"Boolean",data:t};if(t instanceof Date)return{type:"Datetime",data:t.toISOString().split(".")[0]+"Z"};if(t instanceof IndividualModel)return{type:"Uri",data:t.id};if("string"==typeof t||t instanceof String){if(reg_uri.test(t))return{type:"Uri",data:t.valueOf()};if(reg_date.test(t))return{type:"Datetime",data:t.valueOf()};if(reg_ml_string.test(t))return{type:"String",data:t.replace(reg_ml_string,"$1"),lang:t.replace(reg_ml_string,"$2").toUpperCase()};if(reg_round_decimal.test(t))return{type:"Decimal",data:parseFloat(t)};if(t.length)return{type:"String",data:t.valueOf(),...t.language&&{lang:t.language}}}}function updater(t,e){new IndividualModel(t).reset().catch((()=>{}))}function addSingleValue(t,e){if(null!=e){const i=serializer(e);this.properties[t].push(i)}}function removeSingleValue(t,e){if(null!=e){const i=serializer(e);this.properties[t]=(this.properties[t]||[]).filter((t=>!!(t.data!=i.data||t.lang&&i.lang&&t.lang!==i.lang)))}}function toggleSingleValue(t,e){null!=e&&(this.hasValue(t,e)?removeSingleValue.call(this,t,e):addSingleValue.call(this,t,e))}function prefetch(t,e,i,...r){const n=(i=Util$1.unique(i)).filter((e=>{const i=IndividualModel.cache.get(e),r=i&&i.isLoaded();return i&&r&&t.indexOf(i)<0&&t.push(i),!i||!r}));return(n.length?Backend.get_individuals(veda$1.ticket,n):Promise.resolve([])).then((n=>{if(n.forEach((e=>{const i=new IndividualModel(e);t.indexOf(i)<0&&t.push(i)})),e-1==0)return t;const o=[];return i.forEach((t=>{const e=new IndividualModel(t).properties;Object.keys(e).forEach((t=>{"@"===t||r.length&&r.indexOf(t)<0||e[t].forEach((t=>"Uri"===t.type&&o.push(t.data)))}))})),o.length?prefetch(t,e-1,o,...r):t}))}function Ontology(){return Ontology.prototype._singletonInstance?Ontology.prototype._singletonInstance:(Ontology.prototype._singletonInstance=this,this.ontology=[],this.ontologies={},this.datatypes={},this.classes={},this.properties={},this.specifications={},this.models={},this.classTree={},this.templates={},this)}Object.defineProperty(proto$2,"id",{get:function(){return this.properties["@"]},set:function(t){const e=this.properties&&this.properties["@"];this.properties["@"]=t,e&&this._.cache&&IndividualModel.cache.get(e)&&(IndividualModel.cache.delete(e),IndividualModel.cache.set(this.id,this))}}),Object.defineProperty(proto$2,"membership",{get:function(){return this.isNew()?(this._.membership=new IndividualModel({cache:!1}),Promise.resolve(this._.membership)):Backend.get_membership(veda$1.ticket,this.id).then((t=>(this._.membership=new IndividualModel({uri:t,cache:!1}),this._.membership))).catch((t=>(console.error("Membership failed",this.id),this._.membership=new IndividualModel({cache:!1}),this._.membership)))},configurable:!1,enumerable:!1}),proto$2.memberOf=function(){return this.membership.then((t=>t.hasValue("v-s:memberOf")?t.properties["v-s:memberOf"].map((t=>t.data)):[]))},proto$2.isMemberOf=function(t){return this.membership.then((e=>e.hasValue("v-s:memberOf",t)))},Object.defineProperty(proto$2,"rights",{get:function(){return this.isNew()?(this._.rights=new IndividualModel({cache:!1}),this._.rights["v-s:canCreate"]=[!0],this._.rights["v-s:canRead"]=[!0],this._.rights["v-s:canUpdate"]=[!0],this._.rights["v-s:canDelete"]=[!0],Promise.resolve(this._.rights)):Backend.get_rights(veda$1.ticket,this.id).then((t=>(this._.rights=new IndividualModel(t,!1),this._.rights))).catch((t=>(console.error("Rights failed",this.id),this._.rights=new IndividualModel({cache:!1}),this._.rights)))},configurable:!1,enumerable:!1}),proto$2.can=function(t){return t=t.charAt(0).toUpperCase()+t.slice(1).toLowerCase(),this.rights.then((e=>e.hasValue("v-s:can"+t,!0)))},proto$2.canCreate=function(){return this.can("Create")},proto$2.canRead=function(){return this.can("Read")},proto$2.canUpdate=function(){return this.can("Update")},proto$2.canDelete=function(){return this.can("Delete")},Object.defineProperty(proto$2,"rightsOrigin",{get:function(){return Backend.get_rights_origin(veda$1.ticket,this.id).then((t=>(this._.rightsOrigin=Promise.all(t.map((t=>new IndividualModel(t,!1)))),this._.rightsOrigin))).catch((t=>(console.error("Rights failed",this.id),this._.rightsOrigin=[],this._.rightsOrigin)))},configurable:!1,enumerable:!1}),proto$2.watch=function(){updateService&&updateService.subscribe(this,[this.id,this.get("v-s:updateCounter")[0],updater])},proto$2.unwatch=function(){updateService&&updateService.unsubscribe(this.id)},proto$2.load=function(){return this.isLoading()&&"undefined"!=typeof window?this.isLoading():this.isLoading(this.trigger("beforeLoad").then((()=>this.isNew()||this.isLoaded()&&("online"===veda$1.status||"offline"===veda$1.status||!veda$1.status)?this:this.isLoaded()&&"limited"===veda$1.status?this.reset():Backend.get_individual(veda$1.ticket,this.id).then((t=>{this.isSync(!0),this.isLoaded(!0),this.properties=t,this.original=JSON.stringify(t)})))).then((()=>this.init())).then((()=>this.trigger("afterLoad"))).then((()=>(this.isLoading(!1),this.watch(),this))).catch((t=>{throw console.error("Load individual failed",this.id),this.isLoading(!1),t})))},proto$2.save=function(t){return null==t&&(t=!0),this.isSync()?Promise.resolve(this):this.isSaving()&&this.isSync()&&"undefined"!=typeof window?this.isSaving():this.isSaving(this.trigger("beforeSave").then((()=>{this.properties=Object.keys(this.properties).reduce(((t,e)=>("@"===e||t[e].length||delete t[e],t)),this.properties);const e=this.original?JSON.parse(this.original):{"@":this.id},i=Util$1.diff(this.properties,e);return(this.isNew()||t?Backend.put_individual(veda$1.ticket,this.properties):Promise.all([i.added&&Object.keys(i.added).length?(i.added["@"]=this.id,Backend.add_to_individual(veda$1.ticket,i.added)):void 0,i.differ&&Object.keys(i.differ).length?(i.differ["@"]=this.id,Backend.set_in_individual(veda$1.ticket,i.differ)):void 0,i.missing&&Object.keys(i.missing).length?(i.missing["@"]=this.id,Backend.remove_from_individual(veda$1.ticket,i.missing)):void 0])).then((()=>{this.original=JSON.stringify(this.properties),this.isNew(!1),this.isSync(!0),this.isLoaded(!0)}))})).then((()=>this.trigger("afterSave"))).then((()=>(this.isSaving(!1),this.watch(),this))).catch((t=>{throw console.error("Save individual failed",this.id),this.isSaving(!1),t})))},proto$2.saveAll=function(t,e,i){e=e||[],i=i||new WeakSet;const r=this.isNew()||this.isLoaded()&&!this.isSync()&&!this.hasValue("rdf:type","rdfs:Class")&&!this.hasValue("rdf:type","owl:Class");return Promise.resolve().then((()=>r&&this.trigger("beforeSave"))).then((()=>{if(i.has(this))return;i.add(this),r&&e.push(this.properties);let t=[];for(const r in this.properties){if("@"===r)continue;const n=this.get(r);n[0]instanceof IndividualModel&&(t=t.concat(n.map((t=>t.saveAll(this,e,i)))))}for(let r=0;r<this.removedObjs.length;r++){const n=this.removedObjs[r];n instanceof IndividualModel&&(t=t.concat(n.saveAll(this,e,i)))}return Promise.all(t)})).then((()=>!t&&Promise.all(e).then((t=>t.length&&Backend.put_individuals(veda$1.ticket,t))))).then((()=>!t&&e.forEach((t=>{const e=new IndividualModel(t["@"]);e.original=JSON.stringify(t),e.isNew(!1),e.isSync(!0),e.isLoaded(!0),e.watch(),e.trigger("afterSave")})))).catch((t=>{throw console.error("Save individual failed",this.id),t}))},proto$2.reset=function(){const t=t=>{this.original=JSON.stringify(t);const e=Util$1.diff(this.properties,t);return this.properties=t,this.isNew(!1),this.isSync(!0),this.isLoaded(!0),Promise.all(Object.keys(e.added).concat(Object.keys(e.differ),Object.keys(e.missing)).map((t=>{const e=this.get(t);return this.trigger("propertyModified",t,e).then((()=>this.trigger(t,e)))})))};return this.trigger("beforeReset").then((()=>this.isNew()?null:Backend.get_individual(veda$1.ticket,this.id,!1).then(t))).then((()=>this.trigger("afterReset"))).then((()=>(this.watch(),this))).catch((t=>{throw console.error("Reset individual failed",this.id),t}))},proto$2.resetAll=function(t){t=t||new WeakSet;const e=this.isLoaded()&&!this.isSync();return Promise.resolve().then((()=>{if(t.has(this))return;t.add(this);let e=[];for(const i in this.properties){if("@"===i)continue;const r=this.get(i);r[0]instanceof IndividualModel&&(e=e.concat(r.map((e=>e.resetAll(t)))))}return Promise.all(e)})).then((()=>e&&this.reset())).catch((t=>{throw console.error("Reset individual failed",this.id),t}))},proto$2.delete=function(){return this.isDeleting()&&"undefined"!=typeof window?this.isDeleting():this.isDeleting(this.trigger("beforeDelete").then((()=>{if(!this.isNew())return this["v-s:deleted"]=[!0],this.addValue("rdf:type","v-s:Deletable"),this.save()})).then((()=>this.trigger("afterDelete"))).then((()=>(this.isDeleting(!1),this))).catch((t=>{throw console.error("Delete individual failed",this.id),this.isDeleting(!1),t})))},proto$2.remove=function(){return this.isRemoving()&&"undefined"!=typeof window?this.isRemoving():this.isRemoving(this.trigger("beforeRemove").then((()=>{if(IndividualModel.cache.delete(this.id),!this.isNew())return Backend.remove_individual(veda$1.ticket,this.id)})).then((()=>this.trigger("afterRemove"))).then((()=>(this.isRemoving(!1),this.unwatch(),this))).catch((t=>{throw console.error("Remove individual failed",this.id),this.isRemoving(!1),t})))},proto$2.recover=function(){return this.isRecovering()&&"undefined"!=typeof window?this.isRecovering():this.isRecovering(this.trigger("beforeRecover").then((()=>(this["v-s:deleted"]=[!1],this.save()))).then((()=>this.trigger("afterRecover"))).then((()=>(this.isRecovering(!1),this))).catch((t=>{throw console.error("Recover individual failed",this.id),this.isRecovering(!1),t})))},proto$2.hasValue=function(t,e){if(!t&&null!=e){let t=!1;for(const i in this.properties)"@"!==i&&(t=t||this.hasValue(i,e));return t}let i=!(!this.properties[t]||!this.properties[t].length);if(null!=e){const r=serializer(e);i=i&&this.properties[t].some((t=>!(t.type!==r.type||t.data!==r.data||t.lang&&r.lang&&t.lang!==r.lang)))}return i},proto$2.addValue=function(t,e,i){return null==e?Promise.resolve(this):(this.properties[t]=this.properties[t]||[],Array.isArray(e)?e.forEach((e=>addSingleValue.call(this,t,e))):addSingleValue.call(this,t,e),this.isSync(!1),i?Promise.resolve(this):(e=this.get(t),this.trigger("propertyModified",t,e).then((()=>this.trigger(t,e)))))},proto$2.removeValue=function(t,e,i){return t?this.properties[t]&&this.properties[t].length&&null!=e?(Array.isArray(e)?e.forEach((e=>removeSingleValue.call(this,t,e))):removeSingleValue.call(this,t,e),this.isSync(!1),i?Promise.resolve(this):(e=this.get(t),this.trigger("propertyModified",t,e).then((()=>this.trigger(t,e))))):Promise.resolve(this):Object.keys(this.properties).filter((t=>"@"!==t)).reduce(((t,r)=>t.then((()=>this.removeValue(r,e,i)))),Promise.resolve())},proto$2.toggleValue=function(t,e,i){return null==e?Promise.resolve(this):(this.properties[t]=this.properties[t]||[],Array.isArray(e)?e.forEach((e=>toggleSingleValue.call(this,t,e))):toggleSingleValue.call(this,t,e),this.isSync(!1),i?Promise.resolve(this):(e=this.get(t),this.trigger("propertyModified",t,e).then((()=>this.trigger(t,e)))))},proto$2.clearValue=function(t,e){if(!this.properties[t]||!this.properties[t].length)return Promise.resolve(this);if(delete this.properties[t],this.isSync(!1),!e){const e=[];return this.trigger("propertyModified",t,e).then((()=>this.trigger(t,e)))}return Promise.resolve(this)},proto$2.is=function(t){const e=function(i){if(r)return r;if(i.hasValue("rdfs:subClassOf")){if(i.hasValue("rdfs:subClassOf",t.id))return r=r||!0,r;{const t=i.get("rdfs:subClassOf");return Promise.all(t.map(e)).then((t=>t.reduce(((t,e)=>t||e),!1)))}}return r=r||!1,r};"string"==typeof t.valueOf()&&(t=new IndividualModel(t.valueOf()));const i=this.get("rdf:type");let r=i.reduce(((e,i)=>e||this.hasValue("rdf:type",t.id)),!1);return r?Promise.resolve(r):Promise.all(i.map(e)).then((t=>t.reduce(((t,e)=>t||e),!1)))},proto$2.init=function(t){if(!t&&(this.isInited()||!this._.init))return Promise.resolve(this);const e=this.hasValue("rdf:type","owl:Class")||this.hasValue("rdf:type","rdfs:Class");if(this.hasValue("v-ui:hasModel")&&!e)return this.get("v-ui:hasModel")[0].load().then((t=>{if(!t.hasValue("rdf:type","v-ui:ClassModel"))throw new TypeError("v-ui:ClassModel required!");return t.modelFn||(t.modelFn=new Function("veda",t["v-s:script"][0]+" //# sourceURL="+t.id)),t.modelFn.call(this,veda$1),this.isInited(!0),this}));{const t=this.get("rdf:type").map((t=>t.load()));return Promise.all(t).then((t=>{const e=[];return t.map((t=>{t.hasValue("v-ui:hasModel")&&e.push(t.get("v-ui:hasModel")[0].load())})),Promise.all(e)})).then((t=>(t.forEach((t=>{t.modelFn||(t.modelFn=new Function("veda",t.get("v-s:script")[0]+" //# sourceURL="+t.id)),t.modelFn.call(this,veda$1)})),this.isInited(!0),this)))}},proto$2.clone=function(){const t=JSON.parse(JSON.stringify(this.properties));t["@"]=Util$1.genUri();const e=new IndividualModel(t);return e.isNew(!0),e.isSync(!1),e.clearValue("v-s:updateCounter"),e.init()},proto$2.isInited=function(t){return void 0!==t&&(this._.isInited=t),this._.isInited},proto$2.isSync=function(t){return void 0!==t&&(this._.isSync=t),this._.isSync},proto$2.isNew=function(t){return void 0!==t&&(this._.isNew=t),this._.isNew},proto$2.isLoaded=function(t){return void 0!==t&&(this._.isLoaded=t),this._.isLoaded},proto$2.isPending=function(t,e){return void 0!==e&&(this._[t]=e),this._[t]},proto$2.isLoading=function(t){return this.isPending("loading",t)},proto$2.isSaving=function(t){return this.isPending("saving",t)},proto$2.isDeleting=function(t){return this.isPending("deleting",t)},proto$2.isRemoving=function(t){return this.isPending("removing",t)},proto$2.isRecovering=function(t){return this.isPending("recovering",t)},proto$2.toJson=function(){return this.properties},proto$2.toString=function(){return this.hasValue("rdfs:label")?this.get("rdfs:label").map(Util$1.formatValue).join(" "):this.hasValue("rdf:type")?this.get("rdf:type")[0].toString()+": "+this.id:this.id},proto$2.valueOf=function(){return this.id},proto$2.getPropertyChain=function(...t){const e=t.shift();return this.load().then((()=>this.hasValue(e)?t.length?this.getPropertyChain.apply(this[e][0],t):this[e]:[])).catch((t=>(console.error("Get property chain failed"),[])))},proto$2.getChainValue=function(...t){let e=this;Array.isArray(e)||(e=[e]);const i=t.shift(),r=e.map((t=>t.load()));return Promise.all(r).then((e=>{const r=e.reduce(((t,e)=>t.concat(e[i])),[]);return t.length?proto$2.getChainValue.apply(r,t):r})).catch((t=>(console.error("Get chain value failed"),[])))},proto$2.hasChainValue=function(t,...e){return this.getChainValue(...e).then((e=>e.reduce(((e,i)=>e||t.valueOf()==i.valueOf()),!1)))},proto$2.prefetch=function(t,...e){return t=t||1,this.load().then((()=>prefetch([],t,[this.id],...e)))};const proto$1=Ontology.prototype;function User(t){return IndividualModel.call(this,t)}proto$1.init=function(){return this.ontology.length?Promise.resolve(this):"undefined"!=typeof window?fetch("/ontology.json",{mode:"same-origin",cache:"no-cache",credentials:"same-origin"}).then((t=>{if(t.ok)return t.json();throw Error(t.status)})).then((t=>(this.ontology=t,this.processOntology()))).catch((t=>{throw console.error("Ontology load failed"),t})):Backend.query(veda$1.ticket,"'rdf:type' == 'owl:Ontology' || 'rdf:type' == 'rdfs:Class' || 'rdf:type' == 'rdf:Property' || 'rdf:type' == 'rdfs:Datatype' || 'rdf:type' == 'v-ui:PropertySpecification' || 'rdf:type' == 'v-ui:ClassModel'").then((t=>{const e=t.result;return Backend.get_individuals(veda$1.ticket,e)})).then((t=>(this.ontology=t,console.log("Ontology length:",t.length),this.processOntology())))},proto$1.getClassProperties=function(t){const e=this.classTree,i=t=>{const r=e[t];let n;return r?(n=r.properties,[].concat.apply(n,r.superClasses.map(i))):i("rdfs:Resource")};return Util$1.unique(i(t))},proto$1.getClassSpecifications=function(t){const e=this.classTree,i=t=>{const r=e[t];let n;if(r){n=r.specifications;r.superClasses.map(i).map((t=>{for(const e in t)n[e]||(n[e]=t[e])}))}else n=i("rdfs:Resource");return n};return i(t)},proto$1.getClassTemplate=function(t){let e=this.templates[t];return e||(e=this.classes[t].get("v-ui:hasTemplate")),e[0]},proto$1.processOntology=function(){const t=this.ontology,e=this.ontologies,i=this.datatypes,r=this.classes,n=this.properties,o=this.specifications,a=this.classTree,s=this.models,l=this.templates,c=t.map((t=>{if('{"@":""}'!==JSON.stringify(t))return new IndividualModel(t,!0,!1)}));c.forEach((t=>{try{if(!t)return;const a=t.properties["rdf:type"][0].data,c=t.id;switch(a){case"rdfs:Class":case"owl:Class":r[c]=t;break;case"rdf:Property":case"owl:DatatypeProperty":case"owl:ObjectProperty":case"owl:OntologyProperty":case"owl:AnnotationProperty":n[c]=t,IndividualModel.prototype.hasOwnProperty(c)||IndividualModel.defineProperty(c);break;case"v-ui:PropertySpecification":case"v-ui:DatatypePropertySpecification":case"v-ui:ObjectPropertySpecification":o[c]=t;break;case"owl:Ontology":e[c]=t;break;case"rdfs:Datatype":i[c]=t;break;case"v-ui:ClassModel":s[c]=t;break;case"v-ui:TemplateSpecification":const a=t.properties["v-ui:forClass"][0].data;l[a]?l[a].push(t):l[a]=[t]}}catch(e){console.error("Ontology init failed, uri =",t.id)}})),Object.keys(r).forEach((t=>{try{const e=r[t];if(a[e.id]||(a[e.id]={superClasses:[],properties:[],specifications:{}}),"rdfs:Resource"===e.id)return;e.hasValue("rdfs:subClassOf")||(e["rdfs:subClassOf"]=[r["rdfs:Resource"]]),e["rdfs:subClassOf"].map((t=>{a[e.id].superClasses.push(t.id)}))}catch(e){console.error("Ontology init failed, uri =",t)}})),Object.keys(n).forEach((t=>{try{const e=n[t];if(!e["rdfs:domain"])return;e["rdfs:domain"].map((t=>{a[t.id].properties.push(e.id)}))}catch(e){console.error("Ontology init failed, uri =",t)}})),Object.keys(o).forEach((t=>{try{const e=o[t];if(!e["v-ui:forClass"])return;e["v-ui:forClass"].map((t=>{e["v-ui:forProperty"].map((i=>{a[t.id].specifications[i.id]=e.id}))}))}catch(e){console.error("Ontology init failed, uri =",t)}})),Object.keys(l).forEach((t=>{try{l[t]=l[t].sort(((t,e)=>t.properties["v-s:loadPriority"]?e.properties["v-s:loadPriority"]?t.properties["v-s:loadPriority"][0].data-e.properties["v-s:loadPriority"][0].data:-1:1)).map((t=>t.properties["v-ui:defaultTemplate"][0].data))}catch(e){console.error("Ontology init failed, uri =",t)}}));const u=c.map(((t,e)=>t.init().catch((e=>console.error("Ontology individual init failed, uri =",t.id)))));return"undefined"!=typeof window?Promise.all(u).then((()=>this)):Promise.resolve(this)},User.prototype=Object.create(IndividualModel.prototype),User.prototype.constructor=User;const proto=User.prototype;function App(t){riot.observable(this),this.ticket=this.ticket||"",this.ontology={},this.manifest=t,this.init=function(t){const e=new Ontology;return this.ontology=e,e.init().then((()=>(this.user=new User(t),this.user._init())))}}proto.getLanguage=function(){return this.preferences&&this.preferences.language?Object.keys(this.preferences.language):void 0},proto._init=function(){return this.reset().then(this.initAspect.bind(this)).then(this.initAppointment.bind(this)).then(this.initPreferences.bind(this)).then(this.initLanguage.bind(this)).then((()=>{if("cfg:Guest"!==this.id)return this.save()})).catch((t=>{console.error("User init failed")}))},proto.initAspect=function(){const t=this.id+"_aspect";return(this.hasValue("v-s:hasAspect")?this["v-s:hasAspect"][0]:new IndividualModel(t)).reset().catch((e=>{console.error("Personal aspect load failed");const i=new IndividualModel(t);return i["rdf:type"]="v-s:PersonalAspect",i["v-s:owner"]=this,i["rdfs:label"]="PersonalAspect_"+this.id,i["rdfs:comment"]="Create new aspect due to aspect load error\n"+e.stack,"cfg:Guest"!==this.id?i.save():i})).catch((t=>{throw console.error("Personal aspect save failed"),t})).then((t=>{this.hasValue("v-s:hasAspect")||(this["v-s:hasAspect"]=t),this.aspect=t}))},proto.initAppointment=function(){if(this.hasValue("v-s:defaultAppointment"))veda$1.appointment=this["v-s:defaultAppointment"][0];else{if(!this.hasValue("v-s:hasAppointment"))return void(veda$1.appointment=void 0);this["v-s:defaultAppointment"]=[this["v-s:hasAppointment"][0]],veda$1.appointment=this["v-s:defaultAppointment"][0]}return this.on("v-s:defaultAppointment",(()=>{const t=this.hasValue("v-s:defaultAppointment")&&this["v-s:defaultAppointment"][0];t&&t.reset().then((()=>{veda$1.appointment=t})),this.save()})),veda$1.appointment.reset()},proto.initPreferences=function(){const t=this.id+"_pref";return(this.hasValue("v-ui:hasPrefences")?this["v-ui:hasPrefences"][0]:new IndividualModel(t)).reset().catch((e=>{console.error("Personal preferences load failed");const i=new IndividualModel(t);return i["v-s:owner"]=this,i["rdf:type"]="v-ui:Preferences",i["rdfs:label"]="Preferences_"+this.id,this["v-ui:hasPreferences"]=i,"cfg:Guest"!==this.id?i.save():i})).catch((t=>{throw console.error("Personal preferences save failed"),t})).then((t=>(this.hasValue("v-ui:hasPreferences")||(this["v-ui:hasPreferences"]=t),this.preferences=t,t)))},proto.initLanguage=function(t){const e=()=>{t.language=t["v-ui:preferredLanguage"].reduce(((t,e)=>(t[e.id.substr(e.id.indexOf(":")+1)]=e,t)),{}),veda$1.trigger("language:changed")},i=function(){t.displayedElements=t["v-ui:displayedElements"][0]||10},r=()=>{if("cfg:Guest"!==this.id)return t.save()};if(!t.hasValue("v-ui:preferredLanguage")||!t.hasValue("v-ui:displayedElements")){const e=10,i=new IndividualModel("v-ui:RU");t["v-ui:preferredLanguage"]=[i],t["v-ui:displayedElements"]=[e]}return t.on("v-ui:preferredLanguage",e),t.on("v-ui:displayedElements",i),t.on("v-ui:preferredLanguage v-ui:displayedElements",r),e(),i(),r()};const veda=new App;var veda$1=veda;const Sha256={hash:function(t,e){(e=void 0===e||e)&&(t=Utf8.encode(t));const i=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],r=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],n=(t+=String.fromCharCode(128)).length/4+2,o=Math.ceil(n/16),a=new Array(o);for(let e=0;e<o;e++){a[e]=new Array(16);for(let i=0;i<16;i++)a[e][i]=t.charCodeAt(64*e+4*i)<<24|t.charCodeAt(64*e+4*i+1)<<16|t.charCodeAt(64*e+4*i+2)<<8|t.charCodeAt(64*e+4*i+3)}a[o-1][14]=8*(t.length-1)/Math.pow(2,32),a[o-1][14]=Math.floor(a[o-1][14]),a[o-1][15]=8*(t.length-1)&4294967295;const s=new Array(64);let l,c,u,d,f,p,v,_;for(let t=0;t<o;t++){for(let e=0;e<16;e++)s[e]=a[t][e];for(let t=16;t<64;t++)s[t]=Sha256.sigma11(s[t-2])+s[t-7]+Sha256.sigma00(s[t-15])+s[t-16]&4294967295;l=r[0],c=r[1],u=r[2],d=r[3],f=r[4],p=r[5],v=r[6],_=r[7];for(let t=0;t<64;t++){const e=_+Sha256.sigma1(f)+Sha256.ch(f,p,v)+i[t]+s[t],r=Sha256.sigma0(l)+Sha256.maj(l,c,u);_=v,v=p,p=f,f=d+e&4294967295,d=u,u=c,c=l,l=e+r&4294967295}r[0]=r[0]+l&4294967295,r[1]=r[1]+c&4294967295,r[2]=r[2]+u&4294967295,r[3]=r[3]+d&4294967295,r[4]=r[4]+f&4294967295,r[5]=r[5]+p&4294967295,r[6]=r[6]+v&4294967295,r[7]=r[7]+_&4294967295}return Sha256.toHexStr(r[0])+Sha256.toHexStr(r[1])+Sha256.toHexStr(r[2])+Sha256.toHexStr(r[3])+Sha256.toHexStr(r[4])+Sha256.toHexStr(r[5])+Sha256.toHexStr(r[6])+Sha256.toHexStr(r[7])},rotr:function(t,e){return e>>>t|e<<32-t},sigma0:function(t){return Sha256.rotr(2,t)^Sha256.rotr(13,t)^Sha256.rotr(22,t)},sigma1:function(t){return Sha256.rotr(6,t)^Sha256.rotr(11,t)^Sha256.rotr(25,t)},sigma00:function(t){return Sha256.rotr(7,t)^Sha256.rotr(18,t)^t>>>3},sigma11:function(t){return Sha256.rotr(17,t)^Sha256.rotr(19,t)^t>>>10},ch:function(t,e,i){return t&e^~t&i},maj:function(t,e,i){return t&e^t&i^e&i},toHexStr:function(t){let e,i="";for(let r=7;r>=0;r--)e=t>>>4*r&15,i+=e.toString(16);return i}},Utf8={encode:function(t){let e=t.replace(/[\u0080-\u07ff]/g,(function(t){const e=t.charCodeAt(0);return String.fromCharCode(192|e>>6,128|63&e)}));return e=e.replace(/[\u0800-\uffff]/g,(function(t){const e=t.charCodeAt(0);return String.fromCharCode(224|e>>12,128|e>>6&63,128|63&e)})),e},decode:function(t){let e=t.replace(/[\u00e0-\u00ef][\u0080-\u00bf][\u0080-\u00bf]/g,(function(t){const e=(15&t.charCodeAt(0))<<12|(63&t.charCodeAt(1))<<6|63&t.charCodeAt(2);return String.fromCharCode(e)}));return e=e.replace(/[\u00c0-\u00df][\u0080-\u00bf]/g,(function(t){const e=(31&t.charCodeAt(0))<<6|63&t.charCodeAt(1);return String.fromCharCode(e)})),e}};var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(t,e,i){return t(i={path:e,exports:{},require:function(t,e){return commonjsRequire(t,null==e?i.path:e)}},i.exports),i.exports}function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}var mustache=createCommonjsModule((function(t,e){t.exports=function(){
/*!
     * mustache.js - Logic-less {{mustache}} templates with JavaScript
     * http://github.com/janl/mustache.js
     */
var t=Object.prototype.toString,e=Array.isArray||function(e){return"[object Array]"===t.call(e)};function i(t){return"function"==typeof t}function r(t){return e(t)?"array":typeof t}function n(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function o(t,e){return null!=t&&"object"==typeof t&&e in t}function a(t,e){return null!=t&&"object"!=typeof t&&t.hasOwnProperty&&t.hasOwnProperty(e)}var s=RegExp.prototype.test;function l(t,e){return s.call(t,e)}var c=/\S/;function u(t){return!l(c,t)}var d={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function f(t){return String(t).replace(/[&<>"'`=\/]/g,(function(t){return d[t]}))}var p=/\s*/,v=/\s+/,_=/\s*=/,h=/\s*\}/,g=/#|\^|\/|>|\{|&|=|!/;function m(t,i){if(!t)return[];var r,o,a,s=!1,l=[],c=[],d=[],f=!1,m=!1,k="",b=0;function S(){if(f&&!m)for(;d.length;)delete c[d.pop()];else d=[];f=!1,m=!1}function I(t){if("string"==typeof t&&(t=t.split(v,2)),!e(t)||2!==t.length)throw new Error("Invalid tags: "+t);r=new RegExp(n(t[0])+"\\s*"),o=new RegExp("\\s*"+n(t[1])),a=new RegExp("\\s*"+n("}"+t[1]))}I(i||O.tags);for(var j,x,V,C,P,$,E=new y(t);!E.eos();){if(j=E.pos,V=E.scanUntil(r))for(var N=0,D=V.length;N<D;++N)u(C=V.charAt(N))?(d.push(c.length),k+=C):(m=!0,s=!0,k+=" "),c.push(["text",C,j,j+1]),j+=1,"\n"===C&&(S(),k="",b=0,s=!1);if(!E.scan(r))break;if(f=!0,x=E.scan(g)||"name",E.scan(p),"="===x?(V=E.scanUntil(_),E.scan(_),E.scanUntil(o)):"{"===x?(V=E.scanUntil(a),E.scan(h),E.scanUntil(o),x="&"):V=E.scanUntil(o),!E.scan(o))throw new Error("Unclosed tag at "+E.pos);if(P=">"==x?[x,V,j,E.pos,k,b,s]:[x,V,j,E.pos],b++,c.push(P),"#"===x||"^"===x)l.push(P);else if("/"===x){if(!($=l.pop()))throw new Error('Unopened section "'+V+'" at '+j);if($[1]!==V)throw new Error('Unclosed section "'+$[1]+'" at '+j)}else"name"===x||"{"===x||"&"===x?m=!0:"="===x&&I(V)}if(S(),$=l.pop())throw new Error('Unclosed section "'+$[1]+'" at '+E.pos);return U(w(c))}function w(t){for(var e,i,r=[],n=0,o=t.length;n<o;++n)(e=t[n])&&("text"===e[0]&&i&&"text"===i[0]?(i[1]+=e[1],i[3]=e[3]):(r.push(e),i=e));return r}function U(t){for(var e,i=[],r=i,n=[],o=0,a=t.length;o<a;++o)switch((e=t[o])[0]){case"#":case"^":r.push(e),n.push(e),r=e[4]=[];break;case"/":n.pop()[5]=e[2],r=n.length>0?n[n.length-1][4]:i;break;default:r.push(e)}return i}function y(t){this.string=t,this.tail=t,this.pos=0}function k(t,e){this.view=t,this.cache={".":this.view},this.parent=e}function b(){this.templateCache={_cache:{},set:function(t,e){this._cache[t]=e},get:function(t){return this._cache[t]},clear:function(){this._cache={}}}}y.prototype.eos=function(){return""===this.tail},y.prototype.scan=function(t){var e=this.tail.match(t);if(!e||0!==e.index)return"";var i=e[0];return this.tail=this.tail.substring(i.length),this.pos+=i.length,i},y.prototype.scanUntil=function(t){var e,i=this.tail.search(t);switch(i){case-1:e=this.tail,this.tail="";break;case 0:e="";break;default:e=this.tail.substring(0,i),this.tail=this.tail.substring(i)}return this.pos+=e.length,e},k.prototype.push=function(t){return new k(t,this)},k.prototype.lookup=function(t){var e,r=this.cache;if(r.hasOwnProperty(t))e=r[t];else{for(var n,s,l,c=this,u=!1;c;){if(t.indexOf(".")>0)for(n=c.view,s=t.split("."),l=0;null!=n&&l<s.length;)l===s.length-1&&(u=o(n,s[l])||a(n,s[l])),n=n[s[l++]];else n=c.view[t],u=o(c.view,t);if(u){e=n;break}c=c.parent}r[t]=e}return i(e)&&(e=e.call(this.view)),e},b.prototype.clearCache=function(){void 0!==this.templateCache&&this.templateCache.clear()},b.prototype.parse=function(t,e){var i=this.templateCache,r=t+":"+(e||O.tags).join(":"),n=void 0!==i,o=n?i.get(r):void 0;return null==o&&(o=m(t,e),n&&i.set(r,o)),o},b.prototype.render=function(t,e,i,r){var n=this.getConfigTags(r),o=this.parse(t,n),a=e instanceof k?e:new k(e,void 0);return this.renderTokens(o,a,i,t,r)},b.prototype.renderTokens=function(t,e,i,r,n){for(var o,a,s,l="",c=0,u=t.length;c<u;++c)s=void 0,"#"===(a=(o=t[c])[0])?s=this.renderSection(o,e,i,r,n):"^"===a?s=this.renderInverted(o,e,i,r,n):">"===a?s=this.renderPartial(o,e,i,n):"&"===a?s=this.unescapedValue(o,e):"name"===a?s=this.escapedValue(o,e,n):"text"===a&&(s=this.rawValue(o)),void 0!==s&&(l+=s);return l},b.prototype.renderSection=function(t,r,n,o,a){var s=this,l="",c=r.lookup(t[1]);function u(t){return s.render(t,r,n,a)}if(c){if(e(c))for(var d=0,f=c.length;d<f;++d)l+=this.renderTokens(t[4],r.push(c[d]),n,o,a);else if("object"==typeof c||"string"==typeof c||"number"==typeof c)l+=this.renderTokens(t[4],r.push(c),n,o,a);else if(i(c)){if("string"!=typeof o)throw new Error("Cannot use higher-order sections without the original template");null!=(c=c.call(r.view,o.slice(t[3],t[5]),u))&&(l+=c)}else l+=this.renderTokens(t[4],r,n,o,a);return l}},b.prototype.renderInverted=function(t,i,r,n,o){var a=i.lookup(t[1]);if(!a||e(a)&&0===a.length)return this.renderTokens(t[4],i,r,n,o)},b.prototype.indentPartial=function(t,e,i){for(var r=e.replace(/[^ \t]/g,""),n=t.split("\n"),o=0;o<n.length;o++)n[o].length&&(o>0||!i)&&(n[o]=r+n[o]);return n.join("\n")},b.prototype.renderPartial=function(t,e,r,n){if(r){var o=this.getConfigTags(n),a=i(r)?r(t[1]):r[t[1]];if(null!=a){var s=t[6],l=t[5],c=t[4],u=a;0==l&&c&&(u=this.indentPartial(a,c,s));var d=this.parse(u,o);return this.renderTokens(d,e,r,u,n)}}},b.prototype.unescapedValue=function(t,e){var i=e.lookup(t[1]);if(null!=i)return i},b.prototype.escapedValue=function(t,e,i){var r=this.getConfigEscape(i)||O.escape,n=e.lookup(t[1]);if(null!=n)return"number"==typeof n&&r===O.escape?String(n):r(n)},b.prototype.rawValue=function(t){return t[1]},b.prototype.getConfigTags=function(t){return e(t)?t:t&&"object"==typeof t?t.tags:void 0},b.prototype.getConfigEscape=function(t){return t&&"object"==typeof t&&!e(t)?t.escape:void 0};var O={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(t){S.templateCache=t},get templateCache(){return S.templateCache}},S=new b;return O.clearCache=function(){return S.clearCache()},O.parse=function(t,e){return S.parse(t,e)},O.render=function(t,e,i,n){if("string"!=typeof t)throw new TypeError('Invalid template! Template should be a "string" but "'+r(t)+'" was given as the first argument for mustache#render(template, view, partials)');return S.render(t,e,i,n)},O.escape=f,O.Scanner=y,O.Context=k,O.Writer=b,O}()}));function isHoliday(t){try{const e=new IndividualModel("v-s:HolidaysCalendarInstance",!1);e.load();const i=new Date(t);return i.setUTCHours(0,0,0,0),e.get("v-s:holiday").some((t=>i.valueOf()===t.valueOf()))}catch(t){return console.error("Holiday check failed"),!1}}function addWorkingDays(t,e){for(t||(t=new Date);e>0;)t.setDate(t.getDate()+1),isHoliday(t)||e--;return t}const Util={};Util.Sha256=Sha256,Util.Mustache=mustache,Util.genUri=function(){const t=Util.guid();return/^\d/.test(t)?"d:a"+t:"d:"+t},Util.guid=function(){let t=(new Date).getTime();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(t+=performance.now()),"xxxxxxxxxxxxxxxxxxxxxxxxxx".replace(/x/g,(function(e){const i=(t+36*Math.random())%36|0;return t=Math.floor(t/36),i.toString(36)}))},Util.hasValue=function(t,e,i){const r=!!(t&&t[e]&&t[e].length);return i?!(!r||!t[e].filter((t=>t.type===i.type&&t.data.valueOf()===i.data.valueOf())).length):r},Util.toJson=function(t){return JSON.stringify(t,null,2)},Util.addToGroup=function(t,e,i,r,n,o){const a={"@":o||Util.genUri()+"-mbh","rdf:type":Util.newUri("v-s:Membership"),"v-s:memberOf":Util.newUri(e),"v-s:resource":Util.newUri(i)};(r||[]).forEach((t=>{a[t]=Util.newBool(!0)})),(n||[]).forEach((t=>{a[t]=Util.newBool(!1)}));const s=put_individual(t,a);return[a,s]},Util.removeFromGroup=function(t,e,i){const r={"@":Util.genUri()+"-mbh","rdf:type":Util.newUri("v-s:Membership"),"v-s:memberOf":Util.newUri(e),"v-s:resource":Util.newUri(i),"v-s:deleted":Util.newBool(!0)};return[r,put_individual(t,r)]},Util.addRight=function(t,e,i,r,n,o){if(void 0===e||void 0===i)return void console.error("Util.addRight: INVALID ARGS","subj_uri =",e,"obj_uri =",i);const a={"@":o=o||Util.genUri()+"-r","rdf:type":Util.newUri("v-s:PermissionStatement"),"v-s:permissionObject":Util.newUri(i),"v-s:permissionSubject":Util.newUri(e)};(r||[]).forEach((t=>{a[t]=Util.newBool(!0)})),(n||[]).forEach((t=>{a[t]=Util.newBool(!1)}));const s=put_individual(t,a);return[a,s]},Util.clone=function(t){let e;if(null==t||"object"!=typeof t)return t;if(t instanceof Date)return e=new Date,e.setTime(t.getTime()),e;if(t instanceof Array){e=[];for(let i=0,r=t.length;i<r;i++)e[i]=Util.clone(t[i]);return e}if(t instanceof Object){e={};for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=Util.clone(t[i]));return e}throw new Error("Unable to copy obj! Its type isn't supported.")},Util.getPropertyChain=function(...t){let e=t[0];const i=t.length;let r,n,o;for("string"==typeof e&&(e=get_individual(veda$1.ticket,e)),r=1;r<i;r++){if(n=t[r],Util.hasValue(e,n)){if(r===i-1)return e[n].map((t=>t.data));if(o=e[n][0].type,e=e[n][0].data,"Uri"===o){e=get_individual(veda$1.ticket,e);continue}}return}return e},Util.newUri=function(t){return[{data:t,type:"Uri"}]},Util.newStr=function(t,e){const i={data:t,type:"String"};return e&&"NONE"!==e&&(i.lang=e),[i]},Util.newStrFromBundle=function(t,e,i){return i||(i=" "),t["rdfs:label"][0]+i+e["rdfs:label"][0]},Util.newBool=function(t){return[{data:t,type:"Boolean"}]},Util.newInt=function(t){return[{data:t,type:"Integer"}]},Util.newDecimal=function(t){return[{data:t,type:"Decimal"}]},Util.newDate=function(t){return[{data:t.toISOString(),type:"Datetime"}]},Util.addDay=addWorkingDays,Util.isHoliday=isHoliday,Util.getValues=function(t){const e=[];if(t)for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.push(t[i].data);return e},Util.getUris=Util.getValues,Util.getStrings=Util.getValues,Util.getUri=function(t){if(t&&t.length>0)return t[0].data},Util.getFirstValue=function(t){if(t&&t.length>0)return"Integer"==t[0].type?parseInt(t[0].data,10):"Datetime"==t[0].type?new Date(t[0].data):t[0].data},Util.getFirstValueUseLang=function(t,e){for(const i in t)if(t[i].lang==e)return t[i].data;return null},Util.getJournalUri=function(t){return t+"j"},Util.getTraceJournalUri=function(t){return t+"t"},Util.newJournalRecord=function(t){return{"@":Util.genUri()+"-jr","rdf:type":Util.newUri("v-s:JournalRecord"),"v-s:parentJournal":Util.newUri(t),"v-s:created":Util.newDate(new Date)}},Util.logToJournal=function(t,e,i){put_individual(t,i,_event_id);const r={"@":e,"v-s:childRecord":[{data:i["@"],type:"Uri"}]};add_to_individual(t,r,_event_id)},Util.traceToJournal=function(t,e,i,r){const n=Util.newJournalRecord(e);n["rdf:type"]=[{data:"v-wf:TraceRecord",type:"Uri"}],n["rdfs:label"]=[{data:i,type:"String"}],n["rdfs:comment"]=[{data:r,type:"String"}],Util.logToJournal(t,e,n,!0)},Util.create_version=function(t,e,i,r,n){if(!e["v-s:actualVersion"]||e["v-s:actualVersion"][0].data===e["@"]){const o=get_individual(t,r),a=Util.getUri(o["v-s:defaultAppointment"])||Util.getUri(o["v-s:hasAppointment"])||r,s=Util.genUri()+"-vr",l=Util.clone(i);if(l["@"]=s,l["v-s:actualVersion"]=[{data:e["@"],type:"Uri"}],l["v-s:nextVersion"]=[{data:e["@"],type:"Uri"}],Util.hasValue(e,"v-s:previousVersion")&&(l["v-s:previousVersion"]=[{data:e["v-s:previousVersion"][0].data,type:"Uri"}]),l["rdf:type"]=l["rdf:type"].concat([{data:"v-s:Version",type:"Uri"}]),put_individual(t,l,n),Util.addToGroup(t,e["@"],l["@"],["v-s:canRead"]),e["v-s:previousVersion"]){const i=get_individual(t,Util.getUri(e["v-s:previousVersion"]));i["v-s:nextVersion"]=Util.newUri(l["@"]),put_individual(t,i,n)}e["v-s:actualVersion"]=Util.newUri(e["@"]),e["v-s:previousVersion"]=Util.newUri(l["@"]),e["v-s:edited"]=Util.newDate(new Date),e["v-s:lastEditor"]=Util.newUri(a),put_individual(t,e,n)}},Util.recursiveCall=function(t,e,i,r){e[t["@"]]?print("WARNING! Recursive path "+Util.toJson(e)+" > "+t.a):(e[t["@"]]=Object.keys(e).length,t["v-wf:decisionFormList"]&&t["v-wf:decisionFormList"].forEach((t=>{const e=get_individual(i,t.data);e["v-wf:isCompleted"]&&e["v-wf:isCompleted"][0].data||(e["v-s:deleted"]=Util.newBool(!0),e["v-wf:isStopped"]=Util.newBool(!0),put_individual(i,e,r))})),t["v-wf:workItemList"]&&t["v-wf:workItemList"].forEach((t=>{Util.recursiveCall(get_individual(i,t.data),e,i,r)})),t["v-wf:workOrderList"]&&t["v-wf:workOrderList"].forEach((t=>{Util.recursiveCall(get_individual(i,t.data),e,i,r)})),t["v-wf:isProcess"]&&t["v-wf:isProcess"].forEach((t=>{const n=get_individual(i,t.data);n["v-wf:isCompleted"]&&n["v-wf:isCompleted"][0].data||(n["v-wf:isStopped"]=Util.newBool(!0),put_individual(i,n,r)),Util.recursiveCall(n,e,i,r)})))},Util.set_err_on_indv=function(t,e,i){const r={"@":Util.genUri()+"-err","rdf:type":Util.newUri("v-s:BugReport"),"v-s:created":Util.newDate(new Date),"rdfs:comment":Util.newStr(i),"v-s:errorMessage":Util.newStr(t),"v-s:resource":Util.newUri(e["@"])};put_individual(ticket,r,_event_id);const n={"@":e["@"],"v-s:hasError":Util.newUri(r["@"])};add_to_individual(ticket,n,_event_id),print("ERR! "+i+":"+t)},Util.set_field_to_document=function(t,e,i){const r={"@":i};r[t]=e,set_in_individual(ticket,r,_event_id)};const BPMN={addToJournal:function(t,e){if(!get_individual(veda$1.ticket,t))throw console.error(`Journal not found: ${t}`),new Error(`Journal not found: ${t}`);put_individual(veda$1.ticket,e);const i={"@":t,"v-s:childRecord":Util.newUri(e["@"])};add_to_individual(veda$1.ticket,i)},addToGroup:function(t,e,i){const r="d:"+Util.Sha256.hash("membership"+t+e+i);let n=get_individual(veda$1.ticket,r);n||(n={"@":r,"rdf:type":Util.newUri("v-s:Membership"),"v-s:memberOf":Util.newUri(t),"v-s:resource":Util.newUri(e)},i.toLowerCase().split("").forEach((t=>{let e;switch(t){case"c":e="v-s:canCreate";break;case"r":e="v-s:canRead";break;case"u":e="v-s:canUpdate";break;case"d":e="v-s:canDelete";break;default:return}n[e]=Util.newBool(!0)})),put_individual(veda$1.ticket,n))},addRight:function(t,e,i){const r="d:"+Util.Sha256.hash("permission statement"+t+e+i);let n=get_individual(veda$1.ticket,r);n||(n={"@":r,"rdf:type":Util.newUri("v-s:PermissionStatement"),"v-s:permissionSubject":Util.newUri(t),"v-s:permissionObject":Util.newUri(e)},i.toLowerCase().split("").forEach((t=>{let e;switch(t){case"c":e="v-s:canCreate";break;case"r":e="v-s:canRead";break;case"u":e="v-s:canUpdate";break;case"d":e="v-s:canDelete";break;default:return}n[e]=Util.newBool(!0)})),put_individual(veda$1.ticket,n))}},WorkflowUtil={create_work_item:function(t,e,i,r,n,o){try{const a=Util$1.genUri()+"-wit",s={"@":a,"rdf:type":Util.newUri("v-wf:WorkItem"),"v-wf:forProcess":Util.newUri(e),"v-wf:forNetElement":Util.newUri(i),"v-s:created":Util.newDate(new Date),"v-s:creator":Util.newUri("cfg:VedaSystem")};return o&&(s["v-wf:isTrace"]=Util.newBool(!0)),null!==r&&(s["v-wf:previousWorkItem"]=Util.newUri(r)),put_individual(t,s,n),a}catch(t){print(t.stack)}},WorkItemResult:function(t){this.work_item_result=t,this.getValue=function(t){for(const e in this.work_item_result)if(Object.hasOwnProperty.call(this.work_item_result,e))return this.work_item_result[e][t]},this.compare=function(t,e){if(!e||e.length<1)return!1;if(!this.work_item_result||0==this.work_item_result.length)return!1;let i=0;for(const r in this.work_item_result)if(Object.hasOwnProperty.call(this.work_item_result,r)){const n=this.work_item_result[r][t];if(n&&n.length==e.length)for(const t in n)if(Object.hasOwnProperty.call(n,t)){for(const r in e)n[t].data==e[r].data&&n[t].type==e[r].type&&i++;if(i==e.length)return!0}}return!1},this.is_exists_result=function(){if(!this.work_item_result||this.work_item_result.length<1)return!1;for(const t of this.work_item_result)if(t.result)return!0;return!1},this.is_all_executors_taken_decision=function(t,e){if(!e||e.length<1)return!1;let i=0;for(const r of this.work_item_result){const n=r[t];n&&n.length>0&&n[0].data==e[0].data&&n[0].type==e[0].type&&i++}return i===this.work_item_result.length},this.is_some_executor_taken_decision=function(t,e){if(!e||e.length<1)return!1;for(const i of this.work_item_result){const r=i[t];if(r&&r.length>0&&r[0].data==e[0].data&&r[0].type==e[0].type)return!0}return!1}},is_some_content_value:function(t,e){for(const i of t)for(const t of e)if(i.type==t.type&&i.data==t.data)return!0;return!1},Context:function(t,e){this.src_data=t,this.ticket=e,this.getDecisionForms=function(){return this.src_data["v-wf:decisionFormList"]},this.getExecutor=function(){return this.src_data["v-wf:executor"]},this.getLabel=function(){return this.src_data["rdfs:label"]},this.get_results=function(){return this.src_data},this.if_all_executors_taken_decision=function(t,e){try{let i=0;for(const e of this.src_data)e.result==t&&i++;return i==this.src_data.length?[{data:t,type:"Uri"}]:[{data:e,type:"Uri"}]}catch(t){return print(t.stack),!1}},this.getInputVariable=function(t){return this.getVariableValueIO(t,"v-wf:inVars")},this.getLocalVariable=function(t){return this.getVariableValueIO(t,"v-wf:localVars")},this.getOutVariable=function(t){return this.getVariableValueIO(t,"v-wf:outVars")},this.getVariableValueIO=function(t,e){try{const i=this.src_data[e];if(i)for(const e of i){const i=get_individual(this.ticket,e.data);if(!i)continue;if(Util.getFirstValue(i["v-wf:variableName"])==t)return i["v-wf:variableValue"]}}catch(t){return print(t.stack),!1}},this.print_variables=function(t){try{const e=this.src_data[t];if(e)for(const t of e){get_individual(this.ticket,t.data)}}catch(t){return print(t.stack),!1}},this.get_result_value=function(t,e){try{if(this.src_data&&this.src_data.length>0){const i=this.src_data[0][t];return i?[{data:i,type:e}]:null}}catch(t){return print(t.stack),!1}}},get_new_variable:function(t,e){try{const i={"@":Util$1.genUri()+"-var","rdf:type":Util.newUri("v-wf:Variable"),"v-wf:variableName":Util.newStr(t),"v-s:created":Util.newDate(new Date)};return e&&(i["v-wf:variableValue"]=e),i}catch(t){throw print(t.stack),t}},store_items_and_set_minimal_rights:function(t,e){try{const i=[];for(const r of e)null==r["v-s:created"]?r["v-s:created"]=Util.newDate(new Date):r["v-s:edited"]=Util.newDate(new Date),null==r["v-s:creator"]&&(r["v-s:creator"]=Util.newUri("cfg:VedaSystem")),put_individual(t,r,_event_id),i.push({data:r["@"],type:"Uri"});return i}catch(t){print(t.stack)}},generate_variable:function(t,e,i,r,n,o){try{const n=Util.getFirstValue(e["v-wf:varDefineName"]),o=WorkflowUtil.get_new_variable(n,i),a=Util.getUri(e["v-wf:varDefineScope"]);if(a){let e;if("v-wf:Net"==a&&(e=r["@"]),e){o["v-wf:variableScope"]=[{data:e,type:"Uri"}];let a,s=r["v-wf:localVars"];if(s){for(const e of s){const i=get_individual(t,e.data);if(!i)continue;const r=Util.getFirstValue(i["v-wf:variableName"]);if(r&&r==n){a=i;break}}a&&(a["v-wf:variableValue"]=i,put_individual(t,a,_event_id))}else s=[];if(!a){const e=WorkflowUtil.get_new_variable(n,i);put_individual(t,e,_event_id);const o={"@":r["@"],"v-wf:localVars":[{data:e["@"],type:"Uri"}]};add_to_individual(t,o,_event_id),s.push(Util.newUri(e["@"])[0]),r["v-wf:localVars"]=s}}}return o}catch(t){throw print(t.stack),t}},create_and_mapping_variables:function(ticket,mapping,_process,_task,_order,_task_result,f_store,trace_journal_uri,trace_comment){try{const _trace_info=[],new_vars=[];if(!mapping)return[];let process,task,order,task_result;_process&&(process=new WorkflowUtil.Context(_process,ticket)),_task&&(task=new WorkflowUtil.Context(_task,ticket)),_order&&(order=new WorkflowUtil.Context(_order,ticket)),_task_result&&(task_result=new WorkflowUtil.WorkItemResult(_task_result));for(const mapping_item of mapping){const map=get_individual(ticket,mapping_item.data);if(map){const expression=Util.getFirstValue(map["v-wf:mappingExpression"]);if(!expression)continue;try{const res1=eval(expression);if(!res1)continue;const mapToVariable_uri=Util.getUri(map["v-wf:mapToVariable"]);if(!mapToVariable_uri)continue;const def_variable=get_individual(ticket,mapToVariable_uri);if(!def_variable)continue;const new_variable=WorkflowUtil.generate_variable(ticket,def_variable,res1,_process,_task,_task_result);new_variable&&(f_store?(put_individual(ticket,new_variable,_event_id),trace_journal_uri&&_trace_info.push(new_variable),new_vars.push({data:new_variable["@"],type:"Uri"})):new_vars.push(new_variable))}catch(t){trace_journal_uri&&Util.traceToJournal(ticket,trace_journal_uri,"create_and_mapping_variables","err: expression: "+expression+"\n"+t.stack)}}else trace_journal_uri&&Util.traceToJournal(ticket,trace_journal_uri,"create_and_mapping_variables","map not found :"+mapping_item.data)}return trace_journal_uri&&Util.traceToJournal(ticket,trace_journal_uri,"create_and_mapping_variables",trace_comment+" = '"+Util.getUris(mapping)+"' \n\nout = \n"+Util$1.toJson(_trace_info)),new_vars}catch(t){return print(t.stack),[]}},find_in_work_item_tree:function(t,e,i,r){try{const n=[],o=e["v-wf:workItemList"];return o&&WorkflowUtil.rsffiwit(t,o,i,r,n,e),n}catch(t){print(t.stack)}},rsffiwit:function(t,e,i,r,n,o){try{for(const a of e){const e=get_individual(t,a.data);if(e){const a=e[i],s=e["v-wf:isCompleted"];a&&Util.getUri(a)==r&&!s&&n.push({parent:o,work_item:e});const l=e["v-wf:workItemList"];l&&WorkflowUtil.rsffiwit(t,l,i,r,n,e)}}}catch(t){print(t.stack)}},create_new_journal:function(t,e,i,r,n){try{if(!get_individual(t,e)){const o={"@":e,"rdf:type":Util.newUri("v-s:Journal"),"v-s:created":Util.newDate(new Date)};i&&(WorkflowUtil.create_new_journal(t,i,null,"",n),o["v-s:parentJournal"]=Util.newUri(i)),r&&(o["rdfs:label"]=r),n&&(o["v-wf:isTrace"]=Util.newBool(!0)),put_individual(t,o,_event_id)}return e}catch(t){print(t.stack)}},mapToJournal:function(t,e,i,r,n,o,a,s,l){try{if(a&&t){let c=[];if(r&&o&&(r["rdfs:label"]=o),c=WorkflowUtil.create_and_mapping_variables(e,t,i,r,n,null,!1,s,l),c){const t=Util.newJournalRecord(a);for(const e of c){const i=e,r=Util.getFirstValue(i["v-wf:variableName"]),n=i["v-wf:variableValue"];t[r]=n}Util.logToJournal(e,a,t)}}}catch(t){print(t.stack)}},getAppName:function(){const t=get_individual(ticket,"v-s:vedaInfo");return t?Util.getFirstValue(t["rdfs:label"]):""},mapToMessage:function(t,e,i,r,n,o,a,s,l){try{if(a&&t){let o=[];if(o=WorkflowUtil.create_and_mapping_variables(e,t,i,r,n,null,!1,s,l),o){const t={"@":Util$1.genUri()+"-msg","v-s:created":Util.newDate(new Date)};let i;for(const r of o){const n=Util.getFirstValue(r["v-wf:variableName"]),o=r["v-wf:variableValue"];"$template"==n&&(i=get_individual(e,Util.getUri(o))),n.indexOf(":")>0&&(t[n]=o)}if(i){let r=i["v-s:notificationLanguage"];const a=Util.getFirstValue(i["v-s:notificationSubject"]),s=Util.getFirstValue(i["v-s:notificationBody"]);if(r){const t=get_individual(e,r);r=t&&t["rdf:value"]?Util.getFirstValue(t["rdf:value"]).toLowerCase():"RU"}else r="RU";const l={app_name:WorkflowUtil.getAppName};for(const t of o){const i=Util.getFirstValue(t["v-wf:variableName"]);if("$template"==i||i.indexOf(":")>0)continue;const n=t["v-wf:variableValue"],o=[];for(const t in n)if(Object.hasOwnProperty.call(n,t)){let a=n[t];if("Uri"==a.type){const t=get_individual(e,a.data);if(null==t){o.push("ERR! individual ["+a.data+"] not found, var.name="+i);continue}if(null==t["rdfs:label"]){o.push("ERR! individual ["+a.data+"] not contains rdfs:label, var.name="+i);continue}a=Util.getFirstValueUseLang(t["rdfs:label"],r),a||(a=Util.getFirstValue(t["rdfs:label"])),o.push(a)}else{let t="";a.lang!=r&&""!=a.lang&&null!=a.lang&&"NONE"!=a.lang||(t=a.data,o.push(t))}}l[i]=o}const c=mustache.render(a,l).replace(/&#x2F;/g,"/"),u=mustache.render(s,l).replace(/&#x2F;/g,"/");t["v-s:subject"]=Util.newStr(c,r),t["v-s:messageBody"]=Util.newStr(u,r),t["v-wf:onWorkOrder"]=Util.newUri(n["@"]),t["v-s:hasMessageType"]=i["v-s:hasMessageType"],put_individual(e,t,_event_id)}}}}catch(t){print(t.stack)}},create_new_subjournal:function(t,e,i,r){return WorkflowUtil._create_new_subjournal(!1,t,e,i,r)},create_new_trace_subjournal:function(t,e,i,r){const n=e["v-wf:isTrace"];if(!n||n&&!1===Util.getFirstValue(n))return;const o=e["@"],a=WorkflowUtil._create_new_subjournal(!0,t,o,i,r),s={"@":o,"v-wf:traceJournal":Util.newUri(a),"v-s:created":Util.newDate(new Date)};return add_to_individual(ticket,s,_event_id),a},_create_new_subjournal:function(t,e,i,r,n){let o,a;t?(o=Util.getTraceJournalUri(i),a=Util.getTraceJournalUri(e)):(o=Util.getJournalUri(i),a=Util.getJournalUri(e));if(get_individual(ticket,o))return o;WorkflowUtil.create_new_journal(ticket,o,a,r,t);const s=Util.newJournalRecord(a);return s["rdf:type"]=[{data:n,type:"Uri"}],r&&(Array.isArray(r)?s["rdfs:label"]=r:s["rdfs:label"]=[{data:r,type:"String"}]),s["v-s:subJournal"]=[{data:o,type:"Uri"}],Util.logToJournal(ticket,a,s,!0),put_individual(ticket,s,_event_id),o},get_trace_journal:function(t,e){const i=t["v-wf:isTrace"];return i&&!0===Util.getFirstValue(i)?Util.getTraceJournalUri(e["@"]):void 0},create_new_subprocess:function(t,e,i,r,n,o,a){try{const s=o["@"];let l;l=e||i,a&&Util.traceToJournal(t,a,"[WO2.4] executor= "+Util.getUri(i)+" used net",Util.getUri(l));const c=get_individual(t,Util.getUri(l));if(c){const u=Util$1.genUri()+"-prs",d={"@":u,"rdf:type":Util.newUri("v-wf:Process"),"v-wf:instanceOf":l,"v-wf:parentWorkOrder":Util.newUri(s),"v-s:created":Util.newDate(new Date)};let f="  :"+Util.getFirstValue(c["rdfs:label"])+",   "+Util.getFirstValue(r["rdfs:label"]);if(e&&(f+=",  "+Util.getUri(i)),d["rdfs:label"]=[{data:f,type:"String"}],n&&(d["v-wf:inVars"]=n),e&&(d["v-wf:executor"]=i),a){Util.traceToJournal(t,a,"new_process=",Util.getUri(l),Util$1.toJson(d)),d["v-wf:isTrace"]=Util.newBool(!0);const e=Util.getTraceJournalUri(u);e&&(WorkflowUtil.create_new_journal(t,e,null,c["rdfs:label"]),d["v-wf:traceJournal"]=Util.newUri(e))}put_individual(t,d,_event_id),WorkflowUtil.create_new_subjournal(s,u," ","v-wf:SubProcessStarted"),o["v-wf:isProcess"]=[{data:u,type:"Uri"}],put_individual(t,o,_event_id)}}catch(t){print(t.stack)}},get_properties_chain:function(t,e,i){let r,n=[];if(e.length<1)return n;try{r=get_individual(ticket,Util.getUri(t)),r&&WorkflowUtil.traversal(r,e,0,n),!i||null!=n&&0!=n.length||(n=i)}catch(t){print(t.stack)}return n},traversal:function(t,e,i,r){const n=e[i];let o,a,s;for(const t in n)if(Object.hasOwnProperty.call(n,t)){const e=t;"$get"==e&&(o=n[t]),"$go"==e&&(a=n[t]),"$eq"==e&&(s=n[t])}if(a){const n=t[a];for(const t in n)if(Object.hasOwnProperty.call(n,t)){const o=get_individual(ticket,n[t].data);WorkflowUtil.traversal(o,e,i+1,r)}}if(o){let e=!0;if(s){e=!1;const i=Object.keys(s);if(i){const r=i[0],n=t[r];if(n){const t=s[r];for(const i in n)if(n[i].type==t[0].type&&n[i].data==t[0].data){e=!0;break}}}}if(e&&null!=t){const e=t[o];for(const t in e)Object.hasOwnProperty.call(e,t)&&r.push(e[t])}}},remove_empty_branches_from_journal:function(t){const e=get_individual(ticket,t);if(e&&!e["v-s:childRecord"]){const i=Util.getUri(e["v-s:parentJournal"]);if(i){const e=get_individual(ticket,i)["v-s:childRecord"];if(e)for(const r of e){const e=r.data,n=get_individual(ticket,e);if(n&&Util.getUri(n["v-s:subJournal"])==t){remove_from_individual(ticket,{"@":i,"v-s:childRecord":[{data:e,type:"Uri"}]},_event_id);break}}}}},getSystemUrl:function(t){const e=get_individual(ticket,t[0].data);let i=!1;e["v-s:origin"]&&"ExternalUser"===e["v-s:origin"][0].data&&(i=!0);const r=i?Util.newUri("cfg:SystemInfoExternal"):Util.newUri("v-s:vedaInfo");return Util.getFirstValue(WorkflowUtil.get_properties_chain(r,[{$get:"v-s:appUrl"}]))},getInboxUrl:function(t){const e=get_individual(ticket,t[0].data);let i=!1;e["v-s:origin"]&&"ExternalUser"===e["v-s:origin"][0].data&&(i=!0);const r=i?Util.newUri("cfg:SystemInfoExternal"):Util.newUri("v-s:vedaInfo");return Util.getFirstValue(WorkflowUtil.get_properties_chain(r,[{$get:"v-wf:appInboxUrl"}]))},isSubUnitOf:function(t,e,i){if(0==t.length)return!1;print("@@@@@isSubUnitOf run"),i=i||0;const r=get_individual(ticket,t[0].data);return!Util$1.hasValue(r,"v-s:parentUnit")||i>16?(print("@@@@@isSubUnitOf parentUnit empty"),!1):Util$1.hasValue(r,"v-s:parentUnit",{data:e,type:"Uri"})?(print("@@@@@isSubUnitOf parentUnit match"),!0):WorkflowUtil.isSubUnitOf(r["v-s:parentUnit"],e,i+1)}},Convert={transformation:function(t,e,i,r,n,o){const a=i["v-wf:transformScript"];return a?Convert.transformation_script(Util.getStrings(a),t,e,i,r,n,o):Convert.declarative_transformation(t,e,i,r,n,o)},transformation_script:function(tr_script,ticket,individuals,transform,executor,_work_order,process){try{let work_order=Util.getUri(_work_order);!0!==Array.isArray(individuals)&&(individuals=[individuals]);let input_variables={};for(const t in individuals){let e=individuals[t];Util.hasValue(e,"rdf:type",Util.newUri("v-wf:Variable")[0])&&(input_variables[Util.getFirstValue(e["v-wf:variableName"])]=e["v-wf:variableValue"])}const out_data0=[],setVariableValue=function(t,e){const i={"@":Util.genUri()+"-var","rdf:type":Util.newUri("v-wf:Variable"),"v-wf:variableName":Util.newStr(t),"v-wf:variableValue":e};out_data0.push(i)},setVarValueToIndv=function(t,e,i){let r=input_variables[t];r&&(i[e]=r)},getVariableValue=function(t){return Util.getValues(input_variables[t])[0]},getVariableValues=function(t){return Util.getValues(input_variables[t])},getValueFromIndividual=function(t){return individuals[0][t]},getIndividualFromStorage=function(t){return get_individual(ticket,t)},getExecutor=function(){return executor},getWorkOrder=function(){return work_order},saveIndividual=function(t){out_data0.push(t)},newBool=Util.newBool,newStr=Util.newStr,newDate=Util.newDate,newUri=Util.newUri,getUri=Util.getUri,get_properties_chain=WorkflowUtil.get_properties_chain,newUriFromArray=function(t){const e=[];for(const i in t)t[i]&&e.push({data:t[i],type:"Uri"});return e};tr_script="f(); function f() {"+tr_script.toString()+"}",eval(tr_script);for(const t in out_data0)if(Object.hasOwnProperty.call(out_data0,t)){let e=out_data0[t];0==Object.hasOwnProperty.call(e,"@")&&(e["@"]=Util.genUri()+"-tr")}return out_data0}catch(t){console.error("Script Transformation failed err=",t)}},declarative_transformation:function(ticket,individuals,transform,executor,work_order,process){try{const out_data0={};let element;!0!==Array.isArray(individuals)&&(individuals=[individuals]);let rules=transform["v-wf:transformRule"];if(!rules||!rules.length)return;const tmp_rules=[];for(const t in rules)if(Object.hasOwnProperty.call(rules,t)){const e=get_individual(ticket,rules[t].data);e?tmp_rules.push(e):print("not read rule [",Util.toJson(e),"]")}rules=tmp_rules;let out_data0_el={};const putFieldOfIndividFromElement=function(t,e){const i=get_individual(ticket,Util.getUri(element));if(!i)return;let r;r=out_data0_el[t],r||(r=[]),r.push(i[e]),out_data0_el[t]=r},putFieldOfObject=function(t,e){let i;i=out_data0_el[t],i||(i=[]),i.push(individual[e]),out_data0_el[t]=i},putUri=function(t,e){let i;i=out_data0_el[t],i||(i=[]),i.push({data:e,type:"Uri"}),out_data0_el[t]=i},setUri=function(t,e){out_data0_el[t]=[{data:e,type:"Uri"}]},putString=function(t,e){let i;i=out_data0_el[t],i||(i=[]),i.push({data:e,type:"String"}),out_data0_el[t]=i},setString=function(t,e){const i=[];i.push({data:e,type:"String"}),out_data0_el[t]=i},setDatetime=function(t,e){const i=[];i.push({data:e,type:"Datetime"}),out_data0_el[t]=i},putDatetime=function(t,e){let i;i=out_data0_el[t],i||(i=[]),i.push({data:e,type:"Datetime"}),out_data0_el[t]=i},putBoolean=function(t,e){let i;i=out_data0_el[t],i||(i=[]),i.push({data:e,type:"Boolean"}),out_data0_el[t]=i},setBoolean=function(t,e){const i=[];i.push({data:e,type:"Boolean"}),out_data0_el[t]=i},putInteger=function(t,e){let i=out_data0_el[t];i||(i=[]),i.push({data:e,type:"Integer"}),out_data0_el[t]=i},setInteger=function(t,e){const i=[];i.push({data:e,type:"Integer"}),out_data0_el[t]=i},putExecutor=function(t){let e=out_data0_el[t];if(e||(e=[]),!0===Array.isArray(executor))for(const t in executor)Object.hasOwnProperty.call(executor,t)&&e.push(executor[t]);else e.push(executor);out_data0_el[t]=e},putWorkOrder=function(t){let e=out_data0_el[t];if(e||(e=[]),!0===Array.isArray(work_order))for(const t in work_order)Object.hasOwnProperty.call(work_order,t)&&e.push(work_order[t]);else e.push(work_order);out_data0_el[t]=e},putThisProcess=function(t){let e=out_data0_el[t];if(e||(e=[]),!0===Array.isArray(process))for(const t in process)Object.hasOwnProperty.call(process,t)&&e.push(process[t]);else e.push(process);out_data0_el[t]=e},removeThisProcess=function(t){let e=out_data0_el[t];if(e||(e=[]),!0===Array.isArray(process))for(const t in process)Object.hasOwnProperty.call(process,t)&&(e=e.filter((e=>e.data!==process[t])));else e=e.filter((t=>t.data!==process));out_data0_el[t]=e};for(const key in individuals)if(Object.hasOwnProperty.call(individuals,key)){const individual=individuals[key],objectContentStrValue=function(t,e){if(individual[t]){let i=!1;for(const r in individual[t])e===individual[t][r].data&&(i=!0);return i}},iteratedObject=Object.keys(individual);for(const property of iteratedObject){element=individual[property];const putValue=function(t){let e=out_data0_el[t];if(e||(e=[]),"@"==property)e.push({data:element,type:"Uri"});else if(!0===Array.isArray(element))for(const t in element)Object.hasOwnProperty.call(element,t)&&e.push(element[t]);else e.push(element);out_data0_el[t]=e},putValueFrom=function(t,e){let i,r,n=out_data0_el[t];n||(n=[]),i=!0===Array.isArray(element)?Util.getUri(element):element.data?element.data:element,r=get_individual(ticket,i);for(let t=0;t<e.length-1;t++){if(!r||!r[e[t]])return;const i=Array.isArray(r[e[t]])&&r[e[t]][0].data?r[e[t]][0].data:r[e[t]];r=get_individual(ticket,i)}r&&r[e[e.length-1]]&&(n=n.concat(r[e[e.length-1]]),out_data0_el[t]=n)},putFrontValue=function(t){let e=out_data0_el[t];if(e||(e=[]),"@"==property)e.unshift({data:element,type:"Uri"});else if(!0===Array.isArray(element))for(const t in element)Object.hasOwnProperty.call(element,t)&&e.unshift(element[t]);else e.unshift(element);out_data0_el[t]=e},putElement=function(){const t=property;if("@"==t)return;let e=[];if(e=out_data0_el[t],e||(e=[]),!0===Array.isArray(element))for(const t in element)Object.hasOwnProperty.call(element,t)&&e.push(element[t]);else e.push(element);out_data0_el[t]=e},contentName=function(t){return property==t},elementContentStrValue=function(t,e){return property===t&&element[0].data==e},getElement=function(){return element};for(const key3 in rules)if(Object.hasOwnProperty.call(rules,key3)){const rule=rules[key3],segregateObject=rule["v-wf:segregateObject"],segregateElement=rule["v-wf:segregateElement"],grouping=rule["v-wf:grouping"];let res,group_key;if(segregateObject&&(res=eval(segregateObject[0].data),!res))continue;if(segregateElement&&(res=eval(segregateElement[0].data),!res))continue;if(grouping){let t=!1;for(const e in grouping)if(Object.hasOwnProperty.call(grouping,e)){const i=grouping[e].data;"@"==i?t=!0:group_key=i}out_data0_el=out_data0[group_key],out_data0_el||(out_data0_el={},out_data0_el["@"]=t?individual["@"]:Util.genUri()+"-tr")}else out_data0_el={},out_data0_el["@"]=Util.genUri()+"-tr";const aggregate=rule["v-wf:aggregate"];for(const item of aggregate)eval(item.data);grouping?out_data0[group_key]=out_data0_el:out_data0[out_data0_el["@"]]=out_data0_el}}}const out_data=[];for(const t in out_data0)Object.hasOwnProperty.call(out_data0,t)&&out_data.push(out_data0[t]);return out_data}catch(t){console.error("Transformation failed")}}},Codelet={down_right_and_store:function(t,e){return Codelet.change_rights(t,e,[{data:"-r--"}])},change_rights:function(t,e,i){return Codelet.change_rights_actor(t,e,[{data:"-r--"}],"actor")},change_rights_actor:function(t,e,i,r,n,o){try{let a;a=n||t.getInputVariable("docId");const s=[];if(i[0].data.indexOf("r")>=0&&s.push("v-s:canRead"),i[0].data.indexOf("u")>=0&&s.push("v-s:canUpdate"),a){let i;o?i=o:(i=t.getLocalVariable(r)?t.getLocalVariable(r):t.getExecutor(),i||(i=e.getInputVariable(r)),i||(i=[i]));for(const n of i){let i=[n];print("@JS3 executor=",Util.toJson(i));const o=WorkflowUtil.get_properties_chain(i,[{$get:"v-s:employee"}],void 0);if(print("@JS4 employee=",Util.toJson(o)),o){const n=Util.getUri(o);n?Util.addRight(ticket,n,Util.getUri(a),s):print("ERR! change_rights_actor: undefined employee_uri, actor=["+r+"], executor="+Util.toJson(i)+", doc_id="+Util.getUri(a)+", process="+Util.getUri(t)+", task="+Util.getUri(e))}if(i=WorkflowUtil.get_properties_chain(i,[{$get:"v-s:occupation"}],i),i||print("@JS executor undefined, actor=",t.getLocalVariable(r)),i){const n=Util.getUri(i);n?Util.addRight(ticket,n,Util.getUri(a),s):print("ERR! change_rights_actor: undefined executor_uri, actor=["+r+"], executor="+Util.toJson(i)+", doc_id="+Util.getUri(a)+", process="+Util.getUri(t)+", task="+Util.getUri(e))}}}return[WorkflowUtil.get_new_variable("right",Util.newStr("acl1"))]}catch(t){print(t.stack)}},restore_right:function(t){try{return[WorkflowUtil.get_new_variable("result",Util.newStr("Ok"))]}catch(t){print(t.stack)}},complete_process:function(t,e,i){Codelet.change_process_status(t,e,"v-wf:Completed",i)},interrupt_process:function(t,e,i){Codelet.change_process_status(t,e,"v-wf:Interrupted",i)},change_process_status:function(t,e,i,r){const n=e["v-wf:inVars"];if(n)for(const o of n){const n=get_individual(e.ticket,o.data);if(n&&n["v-wf:variableName"][0]&&"docId"==n["v-wf:variableName"][0].data){const o=get_individual(t,n["v-wf:variableValue"][0].data);if(!o["v-wf:isProcess"])continue;for(const n of o["v-wf:isProcess"])if(n.data==e["@"]){delete o["v-wf:isProcess"],o["v-wf:hasStatusWorkflow"]=Util.newUri(i),put_individual(t,o,r);break}}}},change_document_workflow_status:function(t,e){const i=t.getInputVariable("docId");if(i){const r={"@":Util.getUri(i)};r["v-wf:hasStatusWorkflow"]=Util.newUri(e),set_in_individual(t.ticket,r,_event_id)}return[WorkflowUtil.get_new_variable("workflowStatus",Util.newStr(e))]},change_document_status:function(t,e){if(e){const i=t.getInputVariable("setStatus");if(i&&!0===i[0].data){const i=t.getInputVariable("docId");if(i){const r={"@":Util.getUri(i)};if(r["v-s:hasStatus"]=Util.newUri(e),"v-s:StatusExecuted"==e)r["v-s:dateFact"]=Util.newDate(new Date);else if("v-s:StatusExecution"==e){const e=get_individual(t.ticket,Util.getUri(i));if(e&&!e["v-s:dateToPlan"]&&e["v-s:count"]&&e["v-s:count"].length>0){const t=new Date((new Date).setHours(0,0,0,0));r["v-s:dateFromPlan"]=Util.newDate(t);const i=e["v-s:count"][0].data,n=new Date(new Date(Date.now()+864e5*i).setHours(0,0,0,0));r["v-s:dateToPlan"]=Util.newDate(n)}}set_in_individual(t.ticket,r,_event_id)}}}return[WorkflowUtil.get_new_variable("status",Util.newStr(e))]},createPermissionStatement:function(t,e){print("###### Start Codelet.createPermissionStatement ######");const i=t.getInputVariable("docId");let r,n;if(print("docId:",Util.toJson(i)),"rework"===e?(r=t.getLocalVariable("responsible"),n=i[0].data+"-pf-rework"):"task"===e&&(r=t.getLocalVariable("actor"),n=i[0].data+"-pf-task"),print("subjectAppointmentUri: ",Util.toJson(r)),r){const t=get_individual(ticket,r[0].data);if(t){const e={"@":n,"rdf:type":Util.newUri("v-s:PermissionStatement"),"v-s:useFilter":Util.newUri("v-s:StatusStarted"),"v-s:permissionObject":i,"v-s:permissionSubject":t["v-s:employee"].concat(t["v-s:occupation"]),"v-s:canUpdate":Util.newBool("true")};print("@@@@@responsible:",Util.toJson(t["v-s:employee"].concat(t["v-s:occupation"]))),put_individual(ticket,e,_event_id),print("put_individual: ",n)}else print("Error create_permission_statement_executor: not found subjectAppointment: ",r)}else print("Error create_permission_statement_executor: not found local variable 'responsible'");return print("###### Finish Codelet.createPermissionStatement ######"),Util.newStr(n)},deletePermissionStatement:function(t,e){print("###### Start Codelet.deletePermissionStatement ######");const i=t.getInputVariable("docId");let r;print("docId:",Util.toJson(i)),"rework"===e?r=i[0].data+"-pf-rework":"task"===e&&(r=i[0].data+"-pf-task");const n={"@":r,"v-s:deleted":Util.newBool("true")};return set_in_individual(ticket,n),print("###### Finish Codelet.deletePermissionStatement ######"),Util.newStr("empty")},is_exists_net_executor:function(t){try{const e=void 0!==t.getExecutor();return[WorkflowUtil.get_new_variable("res",Util.newBool(e))]}catch(t){print(t.stack)}},get_type_of_docId:function(t){try{let e="?";if(t){const i=t.getInputVariable("docId");if(i){const r=get_individual(t.ticket,i[0].data);r&&(e=r["rdf:type"][0].data)}}return[WorkflowUtil.get_new_variable("res",Util.newUri(e))]}catch(t){print(t.stack)}},is_in_docflow_and_set_if_true:function(t){try{const e=!1;if(t){const e=t.getInputVariable("docId");if(e){const i=Util.getUri(t.src_data["v-wf:forProcess"]),r=get_individual(t.ticket,i);if(r){const i=Util.getUri(r["v-wf:instanceOf"]),n={"@":i+"_"+e[0].data,"rdf:type":[{data:"v-wf:Variable",type:"Uri"}]};put_individual(t.ticket,n,_event_id);const o={"@":e[0].data,"v-wf:isProcess":Util.newUri(r["@"])};print("$ add_to_document >>"+Util.toJson(o)),add_to_individual(ticket,o,_event_id)}}}return[WorkflowUtil.get_new_variable("result",Util.newUri(e))]}catch(t){print(t.stack)}},add_value_to_document:function(t,e){try{let t;if(e){t=e.getInputVariable("src_uri");let i=e.getInputVariable("name_uri");const r=e.getInputVariable("value");let n;if(i&&r&&(n=get_individual(e.ticket,Util.getUri(t)),n)){i=Util.getUri(i);let t=n[i];t||(t=[]);for(const e in r)Object.hasOwnProperty.call(r,e)&&t.push(r[e]);n[i]=t,put_individual(ticket,n,_event_id)}}return[WorkflowUtil.get_new_variable("res",t)]}catch(t){print(t.stack)}},set_value_to_document:function(t,e){try{let t;if(e){t=e.getInputVariable("src_uri");let i=e.getInputVariable("name_uri");const r=e.getInputVariable("value");let n;i&&r&&(n=get_individual(e.ticket,Util.getUri(t)),n&&(i=Util.getUri(i),n[i]=r,put_individual(ticket,n,_event_id)))}return[WorkflowUtil.get_new_variable("res",t)]}catch(t){print(t.stack)}},create_use_transformation:function(t,e){try{const i=[];if(e){const r=e.getInputVariable("src_uri"),n=e.getInputVariable("transformation_uri");if(n){const o=get_individual(e.ticket,Util.getUri(n));if(o){const n=get_individual(e.ticket,Util.getUri(r));if(n){const r=Convert.transformation(e.ticket,n,o,null,null,Util.newUri(t.src_data["@"]));for(const t of r)put_individual(ticket,t,_event_id),i.push({data:t["@"],type:"Uri"})}}}}return[WorkflowUtil.get_new_variable("res",i)]}catch(t){print(t.stack)}},find_long_terms:function(t,e,i){let r=get_from_ght("cid");if(r){const i=get_individual(t,e);if(i){let r=!1;for(const n in i)if(Object.hasOwnProperty.call(i,n)){const o=i[n];if("@"!=n){const t=[];for(const i in o)if(Object.hasOwnProperty.call(o,i)){const a=o[i],s=get_from_ght(a.data);s&&(print("found: value>63,"+e+" "+n+"="+a.data+" -> "+s),a.data=s,r=!0),t.push(a)}r&&(i[n]=t)}else if(get_from_ght(o)){const r=get_from_ght(o);r&&(print("found: uri>63,"+o+"(remove) -> "+r),i["@"]=r,put_individual(t,i,""),remove_individual(t,e,""))}}r&&put_individual(t,i,"")}}else{let e=0;r=new_uris_consumer(),put_to_ght("cid",r),print("new cid="+r);let i="?";for(;i;)if(i=uris_pop(r),i&&(uris_commit_and_next(r,!0),i.length>63)){const r=get_individual(t,i);if(r&&Util.hasValue(r,"rdf:type",{data:"v-s:Appointment",type:"Uri"})){let t=Sha256.hash(i);t="d:appt_"+t.substring(0,50),put_to_ght(i,t),e++}}print("found appointments : "+e)}}},Numerator={};function getNewValue(ticket,individual,rule,scope){try{return eval(rule["v-s:numerationGetNextValue"][0].data)(ticket,scope)}catch(t){print("getNewValue error",t.stack)}}function getScope(ticket,individual,rule){try{return eval(rule["v-s:numerationScope"][0].data)(ticket,individual)}catch(t){print(t.stack)}}function createScope(t,e){try{const i={"@":e,"rdfs:label":[{data:e,type:"String"}],"rdf:type":[{data:"v-s:NumerationScopeClass",type:"Uri"}]};return put_individual(t,i,_event_id),i}catch(t){print(t.stack)}}function commitValue(t,e,i,r){try{let n=null,o=null;if(e["v-s:numerationCommitedInterval"]){for(const r in e["v-s:numerationCommitedInterval"])if(Object.hasOwnProperty.call(e["v-s:numerationCommitedInterval"],r)){const a=e["v-s:numerationCommitedInterval"][r].data,s=get_individual(t,a);try{if(s["v-s:numerationCommitedIntervalBegin"][0].data<=i&&i<=s["v-s:numerationCommitedIntervalEnd"][0].data)return!1;s["v-s:numerationCommitedIntervalBegin"][0].data==i+1?n=s:s["v-s:numerationCommitedIntervalEnd"][0].data==i-1&&(o=s)}catch(t){print("ERR! intervalUri=",a),print(t.stack)}}if(null!=o&&null!=n){o["rdfs:label"][0].data=o["v-s:numerationCommitedIntervalBegin"][0].data+" - "+n["v-s:numerationCommitedIntervalEnd"][0].data,o["v-s:numerationCommitedIntervalEnd"][0].data=n["v-s:numerationCommitedIntervalEnd"][0].data,put_individual(t,o,r),add_to_individual(t,{"@":n["@"],"v-s:deleted":[{data:!0,type:"Boolean"}]},!1);const i=[];for(const t in e["v-s:numerationCommitedInterval"])if(Object.hasOwnProperty.call(e["v-s:numerationCommitedInterval"],t)){const r=e["v-s:numerationCommitedInterval"][t];r.data!=n["@"]&&i.push(r)}e["v-s:numerationCommitedInterval"]=i,put_individual(t,e,r)}else if(null!=o)o["rdfs:label"][0].data=o["v-s:numerationCommitedIntervalBegin"][0].data+" - "+i,o["v-s:numerationCommitedIntervalEnd"][0].data=i,put_individual(t,o,r);else if(null!=n)n["rdfs:label"][0].data=i+" - "+n["v-s:numerationCommitedIntervalEnd"][0].data,n["v-s:numerationCommitedIntervalBegin"][0].data=i,put_individual(t,n,r);else{const n={"@":Util.genUri()+"-intv","rdfs:label":[{data:i+" - "+i,type:"String"}],"rdf:type":[{data:"v-s:NumerationCommitedIntervalClass",type:"Uri"}],"v-s:numerationCommitedIntervalBegin":[{data:i,type:"Integer"}],"v-s:numerationCommitedIntervalEnd":[{data:i,type:"Integer"}]};put_individual(t,n,r),e["v-s:numerationCommitedInterval"].push({data:n["@"],type:"Uri"}),put_individual(t,e,r)}}else{const n={"@":Util.genUri()+"-intv","rdfs:label":[{data:i+" - "+i,type:"String"}],"rdf:type":[{data:"v-s:NumerationCommitedIntervalClass",type:"Uri"}],"v-s:numerationCommitedIntervalBegin":[{data:i,type:"Integer"}],"v-s:numerationCommitedIntervalEnd":[{data:i,type:"Integer"}]};put_individual(t,n,r),e["v-s:numerationCommitedInterval"]=[{data:n["@"],type:"Uri"}],put_individual(t,e,r)}return!0}catch(t){print(t.stack)}}function revokeValue(t,e,i,r){try{const n=[];for(const o in e["v-s:numerationCommitedInterval"])if(Object.hasOwnProperty.call(e["v-s:numerationCommitedInterval"],o)){const a=e["v-s:numerationCommitedInterval"][o],s=get_individual(t,a.data);if(s["v-s:numerationCommitedIntervalBegin"][0].data==i)s["v-s:numerationCommitedIntervalBegin"][0].data<s["v-s:numerationCommitedIntervalEnd"][0].data?(put_individual(t,{"@":s["@"],"rdfs:label":[{data:i+1+" - "+s["v-s:numerationCommitedIntervalEnd"][0].data,type:"String"}],"rdf:type":[{data:"v-s:NumerationCommitedIntervalClass",type:"Uri"}],"v-s:numerationCommitedIntervalBegin":[{data:i+1,type:"Integer"}],"v-s:numerationCommitedIntervalEnd":[{data:s["v-s:numerationCommitedIntervalEnd"][0].data,type:"Integer"}]},r),n.push(a)):add_to_individual(t,{"@":s["@"],"v-s:deleted":[{data:!0,type:"Boolean"}]},!1);else if(s["v-s:numerationCommitedIntervalEnd"][0].data==i)s["v-s:numerationCommitedIntervalBegin"][0].data<s["v-s:numerationCommitedIntervalEnd"][0].data?(put_individual(t,{"@":s["@"],"rdfs:label":[{data:s["v-s:numerationCommitedIntervalBegin"][0].data+" - "+(i-1),type:"String"}],"rdf:type":[{data:"v-s:NumerationCommitedIntervalClass",type:"Uri"}],"v-s:numerationCommitedIntervalBegin":[{data:s["v-s:numerationCommitedIntervalBegin"][0].data,type:"Integer"}],"v-s:numerationCommitedIntervalEnd":[{data:i-1,type:"Integer"}]},r),n.push(a)):add_to_individual(t,{"@":s["@"],"v-s:deleted":[{data:!0,type:"Boolean"}]},!1);else if(s["v-s:numerationCommitedIntervalBegin"][0].data<i&&i<s["v-s:numerationCommitedIntervalEnd"][0].data){put_individual(t,{"@":s["@"],"rdfs:label":[{data:s["v-s:numerationCommitedIntervalBegin"][0].data+" - "+(i-1),type:"String"}],"rdf:type":[{data:"v-s:NumerationCommitedIntervalClass",type:"Uri"}],"v-s:numerationCommitedIntervalBegin":[{data:s["v-s:numerationCommitedIntervalBegin"][0].data,type:"Integer"}],"v-s:numerationCommitedIntervalEnd":[{data:i-1,type:"Integer"}]},r),n.push(a);const e={data:Util.genUri()+"-intv",type:"Uri"};put_individual(t,{"@":e.data,"rdfs:label":[{data:i+1+" - "+s["v-s:numerationCommitedIntervalEnd"][0].data,type:"String"}],"rdf:type":[{data:"v-s:NumerationCommitedIntervalClass",type:"Uri"}],"v-s:numerationCommitedIntervalBegin":[{data:i+1,type:"Integer"}],"v-s:numerationCommitedIntervalEnd":[{data:s["v-s:numerationCommitedIntervalEnd"][0].data,type:"Integer"}]},r),n.push(e)}else n.push(a)}e["v-s:numerationCommitedInterval"]=n,put_individual(t,e,r)}catch(t){print(t.stack)}}function PrepareWorkOrder(ticket,document){try{const _work_order=document,f_executor=document["v-wf:executor"];let executor=get_individual(ticket,Util.getUri(f_executor));if(f_executor&&!executor)return;executor&&""==executor["@"]&&(executor=void 0);const f_forWorkItem=Util.getUri(document["v-wf:forWorkItem"]);var work_item=get_individual(ticket,f_forWorkItem);if(!work_item)return;const forProcess=work_item["v-wf:forProcess"],forProcess_uri=Util.getUri(forProcess),_process=get_individual(ticket,forProcess_uri);if(!_process)return;const isStopped=_process["v-wf:isStopped"];if(isStopped&&!0===isStopped[0].data)return;const trace_journal_uri=WorkflowUtil.create_new_trace_subjournal(f_forWorkItem,_work_order,"prepare_work_order:"+_work_order["@"],"v-wf:WorkOrderStarted");let journal_uri;trace_journal_uri&&Util.traceToJournal(ticket,trace_journal_uri,"  ",Util$1.toJson(document));let f_inVars=work_item["v-wf:inVars"];f_inVars||(f_inVars=[]);const forNetElement=work_item["v-wf:forNetElement"],net_element=get_individual(ticket,Util.getUri(forNetElement));if(!net_element)return;const f_local_outVars=document["v-wf:outVars"];let task_output_vars=[];const f_useSubNet=document["v-wf:useSubNet"];if(!f_local_outVars)if(journal_uri=WorkflowUtil.create_new_subjournal(f_forWorkItem,_work_order["@"],net_element["rdfs:label"],"v-wf:WorkOrderStarted"),executor||WorkflowUtil.mapToMessage(net_element["v-wf:startingMessageMap"],ticket,_process,work_item,_work_order,null,journal_uri,trace_journal_uri,"v-wf:startingMessageMap"),executor){const is_appointment=Util$1.hasValue(executor,"rdf:type",{data:"v-s:Appointment",type:"Uri"}),is_position=Util$1.hasValue(executor,"rdf:type",{data:"v-s:Position",type:"Uri"}),is_codelet=Util$1.hasValue(executor,"rdf:type",{data:"v-s:Codelet",type:"Uri"}),is_person=Util$1.hasValue(executor,"rdf:type",{data:"v-s:Person",type:"Uri"});if(is_codelet){WorkflowUtil.mapToMessage(net_element["v-wf:startingMessageMap"],ticket,_process,work_item,_work_order,null,journal_uri,trace_journal_uri,"v-wf:startingMessageMap");const expression=Util.getFirstValue(executor["v-s:script"]);if(!expression)return;const task=new WorkflowUtil.Context(work_item,ticket),process=new WorkflowUtil.Context(_process,ticket),codelet_output_vars=eval(expression);if(codelet_output_vars&&codelet_output_vars.length>0){const t=WorkflowUtil.store_items_and_set_minimal_rights(ticket,codelet_output_vars);_work_order["v-wf:outVars"]=t,put_individual(ticket,_work_order,_event_id)}}else if((is_appointment||is_position||is_person)&&!f_useSubNet){const t=[];for(const e of f_inVars){const i=get_individual(ticket,e.data);t.push(i)}let e,i=work_item;for(;!e;){const t=Util.getUri(i["v-wf:previousWorkItem"]);if(!t)break;const r=get_individual(ticket,t);if(!r)break;const n=Util.getUri(r["v-wf:forNetElement"]);if(!n)break;const o=get_individual(ticket,n);if(!o)break;if("v-wf:Task"==o["rdf:type"][0].data){e=r["v-wf:forNetElement"];break}i=r}let r={"@":"-","rdf:type":[{data:"v-wf:Variable",type:"Uri"}],"v-wf:variableName":[{data:"curTask",type:"String"}],"v-wf:variableValue":forNetElement};t.push(r),e&&(r={"@":"-","rdf:type":[{data:"v-wf:Variable",type:"Uri"}],"v-wf:variableName":[{data:"prevTask",type:"String"}],"v-wf:variableValue":e},t.push(r)),WorkflowUtil.mapToJournal(net_element["v-wf:startingExecutorJournalMap"],ticket,_process,work_item,_work_order,null,journal_uri,trace_journal_uri,"v-wf:startingExecutorJournalMap");const n=Util.getUri(net_element["v-wf:startDecisionTransform"]);if(!n)return;const o=get_individual(ticket,n);if(!o)return;const a=Convert.transformation(ticket,t,o,f_executor,Util.newUri(document["@"]),forProcess);trace_journal_uri&&Util.traceToJournal(ticket,trace_journal_uri,"v-wf:startDecisionTransform","transform_result="+Util$1.toJson(a));const s=[];if(a)for(const t of a){if(null==t["v-s:created"]?t["v-s:created"]=Util.newDate(new Date):t["v-s:edited"]=Util.newDate(new Date),null==t["v-s:creator"]&&(t["v-s:creator"]=Util.newUri("cfg:VedaSystem")),put_individual(ticket,t,_event_id),s.push({data:t["@"],type:"Uri"}),is_appointment){const e=executor["v-s:employee"];e&&Util.addRight(ticket,e[0].data,t["@"],["v-s:canRead","v-s:canUpdate"]);const i=executor["v-s:occupation"];i&&Util.addRight(ticket,i[0].data,t["@"],["v-s:canRead","v-s:canUpdate"])}if((is_position||is_person)&&Util.addRight(ticket,executor["@"],t["@"],["v-s:canRead","v-s:canUpdate"]),Util$1.hasValue(t,"v-wf:onDocument")){const e=Util.getUri(t["v-wf:onDocument"]);Util.addToGroup(ticket,e,t["@"],["v-s:canRead"],void 0,"d:membership_"+t["@"].split(":").join("_")+"_"+e.split(":").join("_"))}}const l={"@":document["@"],"v-wf:decisionFormList":s};add_to_individual(ticket,l,_event_id),_work_order["v-wf:decisionFormList"]=s,WorkflowUtil.mapToMessage(net_element["v-wf:startingMessageMap"],ticket,_process,work_item,_work_order,null,journal_uri,trace_journal_uri,"v-wf:startingMessageMap")}!Util$1.hasValue(executor,"rdf:type",{data:"v-wf:Net",type:"Uri"})&&!f_useSubNet||is_codelet||WorkflowUtil.create_new_subprocess(ticket,f_useSubNet,f_executor,net_element,f_inVars,document,trace_journal_uri)}else net_element["v-wf:completedMapping"]?task_output_vars=WorkflowUtil.create_and_mapping_variables(ticket,net_element["v-wf:completedMapping"],_process,work_item,null,null,!0,trace_journal_uri,"v-wf:completedMapping"):task_output_vars.push({data:"v-wf:complete",type:"Uri"}),0==task_output_vars.length&&task_output_vars.push({data:"v-wf:complete",type:"Uri"}),task_output_vars.length>0&&(document["v-wf:outVars"]=task_output_vars,put_individual(ticket,document,_event_id));let is_goto_to_next_task=!1,is_have_enforce_order=!1;const work_item_result=[],wosResultsMapping=net_element["v-wf:wosResultsMapping"];work_item=get_individual(ticket,f_forWorkItem);const workOrderList=work_item["v-wf:workOrderList"];if(workOrderList)for(const t of workOrderList){let e;e=t.data!=document["@"]?get_individual(ticket,t.data):document,is_have_enforce_order=is_have_enforce_order||Util$1.hasValue(e,"v-wf:enforceProcessing",{data:!0,type:"Boolean"});const i=e["v-wf:outVars"];if(i){const t={};t.workOrder=e["@"];let r=!1;for(const e of i){const i=get_individual(ticket,e.data);if(i)if(wosResultsMapping);else{let e,n;const o=i["v-wf:variableName"];o&&(e=o[0].data);const a=i["v-wf:variableValue"];a&&(n=a),void 0!==e&&(t[e]=n,r=!0)}}r&&work_item_result.push(t)}}work_item_result.length==workOrderList.length?is_goto_to_next_task=!0:trace_journal_uri&&Util.traceToJournal(ticket,trace_journal_uri,"[WO4.0]    ","stop. work_item_result"+Util$1.toJson(work_item_result)+", workOrderList=",Util$1.toJson(workOrderList)),trace_journal_uri&&Util.traceToJournal(ticket,trace_journal_uri,"[WO4] work_item_result",Util$1.toJson(work_item_result));const workItemList=[];if(is_goto_to_next_task)if(!is_have_enforce_order&&work_item["v-wf:isCompleted"]&&!0===work_item["v-wf:isCompleted"][0].data)Util.traceToJournal(ticket,trace_journal_uri,"[WO4] work_item already is completed, stop. ",Util$1.toJson(work_item));else{journal_uri=Util.getJournalUri(_work_order["@"]),work_item_result.length>0&&(work_item_result[0].complete||WorkflowUtil.mapToJournal(net_element["v-wf:completedJournalMap"],ticket,_process,work_item,null,net_element["rdfs:label"],journal_uri)),net_element["v-wf:completedMapping"]&&(task_output_vars=WorkflowUtil.create_and_mapping_variables(ticket,net_element["v-wf:completedMapping"],_process,work_item,null,work_item_result,!0,trace_journal_uri,"v-wf:completedMapping"));const hasFlows=net_element["v-wf:hasFlow"];if(hasFlows){const split=Util.getUri(net_element["v-wf:split"]);for(const item of hasFlows){const flow=get_individual(ticket,item.data);if(!flow)continue;const flowsInto=flow["v-wf:flowsInto"];if(!flowsInto)continue;const predicate=flow["v-wf:predicate"];if(predicate){const expression=Util.getFirstValue(predicate);if(expression)try{const task_result=new WorkflowUtil.WorkItemResult(work_item_result),task=new WorkflowUtil.Context(work_item,ticket),process=new WorkflowUtil.Context(_process,ticket),res1=eval(expression);if(trace_journal_uri&&Util.traceToJournal(ticket,trace_journal_uri,"in flow expression",Util$1.toJson(expression)+", res ="+Util$1.toJson(res1)),!0===res1){const t=get_individual(ticket,Util.getUri(flowsInto));if(t){const e=WorkflowUtil.create_work_item(ticket,forProcess_uri,t["@"],work_item["@"],_event_id,trace_journal_uri);workItemList.push({data:e,type:"Uri"})}if("v-wf:XOR"==split)break}}catch(t){trace_journal_uri&&Util.traceToJournal(ticket,trace_journal_uri,"in flow expression",Util$1.toJson(expression)+", ",Util$1.toJson(t.stack)),print(t.stack)}}else if(!split||"v-wf:None"==split){const t=get_individual(ticket,Util.getUri(flowsInto));if(t){const e=WorkflowUtil.create_work_item(ticket,forProcess_uri,t["@"],work_item["@"],_event_id,trace_journal_uri);workItemList.push({data:e,type:"Uri"})}}}}work_item["v-wf:isCompleted"]=[{data:!0,type:"Boolean"}],workItemList.length>0&&(work_item["v-wf:workItemList"]=workItemList),task_output_vars.length>0&&(work_item["v-wf:outVars"]=task_output_vars),put_individual(ticket,work_item,_event_id),WorkflowUtil.remove_empty_branches_from_journal(journal_uri)}}catch(t){print(t.stack)}}function PrepareWorkItem(ticket,document){const work_item=document;try{const forProcess=Util.getUri(work_item["v-wf:forProcess"]),_process=get_individual(ticket,forProcess);if(!_process)return;const instanceOf=Util.getUri(_process["v-wf:instanceOf"]),_net=get_individual(ticket,instanceOf);if(!_net)return;const forNetElement=document["v-wf:forNetElement"],netElement=get_individual(ticket,Util.getUri(forNetElement));if(!netElement)return;let trace_journal_uri;const isCompleted=document["v-wf:isCompleted"];if(isCompleted&&!0===isCompleted[0].data)return trace_journal_uri=WorkflowUtil.get_trace_journal(document,_process),trace_journal_uri&&Util.traceToJournal(ticket,trace_journal_uri,"prepare_work_item:completed, exit",work_item["@"]),void WorkflowUtil.remove_empty_branches_from_journal(Util.getJournalUri(work_item["@"]));trace_journal_uri=WorkflowUtil.create_new_trace_subjournal(forProcess,work_item,netElement["@"]+"' - ["+Util.getValues(netElement["rdfs:label"])+"] - "+work_item["@"],"v-wf:WorkItemStarted");const f_join=netElement["v-wf:join"];if(f_join&&"v-wf:AND"==Util.getUri(f_join)){const t=[],e={},i=_net["v-wf:consistsOf"];if(i)for(const r of i){const i=get_individual(ticket,r.data);if(i)if(Util$1.hasValue(i,"rdf:type",{data:"v-wf:Flow",type:"Uri"}))Util.getUri(i["v-wf:flowsInto"])==netElement["@"]&&t.push(i);else if(Util$1.hasValue(i,"rdf:type",{data:"v-wf:Task",type:"Uri"})){const t=i["v-wf:hasFlow"];if(t)for(const r of t)e[r.data]=i["@"]}}const r=WorkflowUtil.find_in_work_item_tree(ticket,_process,"v-wf:forNetElement",Util.getUri(forNetElement));if(r.length>t.length&&print("ERR! AND join: check v-wf:consistsOf in net["+instanceOf+"] for net element ["+Util.getUri(forNetElement)+"]"),r.length!=t.length)return;let n=0,o;for(const i of t){const t=e[i["@"]];for(const e of r){const i=Util.getUri(e.parent["v-wf:forNetElement"]);if(o=e.work_item["v-s:isExecuted"],o)return;if(t==i){n++;break}}}if(n!=t.length)return}document["v-s:isExecuted"]=Util.newBool(!0),put_individual(ticket,document,_event_id);let is_completed=!1;const workItemList=[];let is_goto_to_next_task=!1,task_output_vars=[],journal_uri;if(Util$1.hasValue(netElement,"rdf:type",{data:"v-wf:Task",type:"Uri"})){journal_uri=WorkflowUtil.create_new_subjournal(forProcess,work_item["@"],netElement["rdfs:label"],"v-wf:WorkItemStarted"),trace_journal_uri&&Util.traceToJournal(ticket,trace_journal_uri,"Is task");let work_item__inVars=[];netElement["v-wf:startingMapping"]&&(work_item__inVars=WorkflowUtil.create_and_mapping_variables(ticket,netElement["v-wf:startingMapping"],_process,document,null,null,!0,trace_journal_uri,"v-wf:startingMapping"),work_item__inVars.length>0&&(document["v-wf:inVars"]=work_item__inVars));const executor_list=[],f_subNet=netElement["v-wf:subNet"],f_executor=netElement["v-wf:executor"];if(f_executor)for(const item of f_executor){const executor=get_individual(ticket,item.data);if(executor)if(Util$1.hasValue(executor,"rdf:type",{data:"v-wf:ExecutorDefinition",type:"Uri"})){const expression=Util.getFirstValue(executor["v-wf:executorExpression"]);if(!expression)return;const task=new WorkflowUtil.Context(document,ticket),process=new WorkflowUtil.Context(_process,ticket);try{const result=eval(expression);if(trace_journal_uri&&Util.traceToJournal(ticket,trace_journal_uri,"  ["+expression+"]","executors="+Util$1.toJson(result)),void 0!==result&&result.length>0)for(const t of result){const e=get_individual(ticket,t.data);e&&executor_list.push(t)}}catch(t){trace_journal_uri&&Util.traceToJournal(ticket,trace_journal_uri,"    ["+expression+"]",t.stack)}}else trace_journal_uri&&Util.traceToJournal(ticket,trace_journal_uri,"  ","executor="+Util$1.toJson(item.data)),executor_list.push(item);else trace_journal_uri&&Util.traceToJournal(ticket,trace_journal_uri,"  "," uri=["+item.data+"]")}else f_subNet&&executor_list.push(f_subNet[0]);0==executor_list.length?executor_list.push(null):WorkflowUtil.mapToJournal(netElement["v-wf:startingJournalMap"],ticket,_process,document,null,netElement["rdfs:label"],journal_uri);const work_order_list=[],work_order_uri_list=[];for(const t of executor_list){const e=Util$1.genUri()+"-wo",i={"@":e,"rdf:type":[{data:"v-wf:WorkOrder",type:"Uri"}],"v-wf:forWorkItem":[{data:document["@"],type:"Uri"}]};f_subNet&&(i["v-wf:useSubNet"]=f_subNet),trace_journal_uri&&(i["v-wf:isTrace"]=Util.newBool(!0)),null!=t&&(i["v-wf:executor"]=t),work_order_list.push(i),work_order_uri_list.push({data:e,type:"Uri"})}work_order_uri_list.length>0&&(document["v-wf:workOrderList"]=work_order_uri_list),(work_item__inVars>0||work_order_uri_list.length>0)&&put_individual(ticket,document,_event_id);for(const t of work_order_list)put_individual(ticket,t,_event_id)}else if(Util$1.hasValue(netElement,"rdf:type",{data:"v-wf:InputCondition",type:"Uri"})||Util$1.hasValue(netElement,"rdf:type",{data:"v-wf:Condition",type:"Uri"})){if("s-wf:InterlayerNet_ic"==netElement["@"]){const t={"@":_process["v-wf:executor"][0].data};t["v-wf:hasStatusWorkflow"]=Util.newUri("v-wf:IsSent"),set_in_individual(ticket,t,_event_id)}is_goto_to_next_task=!0}else if(Util$1.hasValue(netElement,"rdf:type",{data:"v-wf:OutputCondition",type:"Uri"})){if(trace_journal_uri&&Util.traceToJournal(ticket,trace_journal_uri,"Is output condition ",""),"s-wf:InterlayerNet_oc"==netElement["@"]){const t={"@":_process["v-wf:executor"][0].data};t["v-wf:hasStatusWorkflow"]=Util.newUri("v-wf:Completed"),set_in_individual(ticket,t,_event_id)}const t=_process["v-wf:parentWorkOrder"];if(t){const e=get_individual(ticket,Util.getUri(t));e&&(_net["v-wf:completedMapping"]?task_output_vars=WorkflowUtil.create_and_mapping_variables(ticket,_net["v-wf:completedMapping"],_process,work_item,null,null,!0,trace_journal_uri,"v-wf:completedMapping"):task_output_vars.push({data:"v-wf:complete",type:"Uri"}),task_output_vars.length>0&&(e["v-wf:outVars"]=task_output_vars,put_individual(ticket,e,_event_id)))}is_completed=!0,document["v-wf:isCompleted"]=[{data:is_completed,type:"Boolean"}];const e={"@":forProcess,"v-wf:isCompleted":[{data:is_completed,type:"Boolean"}]};Codelet.complete_process(ticket,_process,_event_id),set_in_individual(ticket,e,_event_id)}if(is_goto_to_next_task){const hasFlows=netElement["v-wf:hasFlow"];if(hasFlows)for(const hasFlow of hasFlows){const flow=get_individual(ticket,hasFlow.data);if(!flow)continue;const flowsInto=flow["v-wf:flowsInto"];if(!flowsInto)continue;let resultEval=!0;try{const predicate=flow["v-wf:predicate"];if(predicate){const expression=Util.getFirstValue(predicate),task=new WorkflowUtil.Context(work_item,ticket),process=new WorkflowUtil.Context(_process,ticket);resultEval=eval(expression)}}catch(t){print(t.stack)}if(!resultEval)continue;const nextNetElement=get_individual(ticket,Util.getUri(flowsInto));if(!nextNetElement)continue;const work_item_uri=WorkflowUtil.create_work_item(ticket,forProcess,nextNetElement["@"],document["@"],_event_id,trace_journal_uri);workItemList.push({data:work_item_uri,type:"Uri"}),document["v-wf:isCompleted"]=Util.newBool(!0),document["v-s:isExecuted"]=Util.newBool(!1),document["v-s:created"]=Util.newDate(new Date),is_completed=!0}}workItemList.length>0&&(document["v-wf:workItemList"]=workItemList),(is_completed||workItemList.length>0)&&put_individual(ticket,document,_event_id)}catch(t){print(t.stack)}}function PrepareDecisionForm(t,e,i){try{const r=e;let n=null;i&&(n=i["v-wf:takenDecision"]);const o=r["v-wf:takenDecision"];if(!o&&!n)return;const a=Util$1.hasValue(r,"v-wf:enforceProcessing",{data:!0,type:"Boolean"});if(n&&!a)return void(o?o.length==n.length&&Util.getUri(o)==Util.getUri(n)||(Util.set_err_on_indv("attempt set another decision "+Util$1.toJson(o)+", restore previous decision",e,"prepare decision form"),Util.set_field_to_document("v-wf:takenDecision",n,r["@"])):(Util.set_err_on_indv("attempt clear decision["+Util.getUri(n)+"], restore previous decision",e,"prepare decision form"),Util.set_field_to_document("v-wf:takenDecision",n,r["@"])));if(r["v-wf:isCompleted"]&&!0===r["v-wf:isCompleted"][0].data)return;const s=e["v-wf:onWorkOrder"],l=get_individual(t,Util.getUri(s));if(!l)return void Util.set_err_on_indv("WorkOrder["+Util.getUri(s)+"], not found",e,"prepare decision form");const c=l["v-wf:executor"];let u;c&&c.length>0&&(u=c[0]);const d=l["v-wf:forWorkItem"],f=get_individual(t,Util.getUri(d));if(!f)return void Util.set_err_on_indv("invalid WorkOrder["+Util.getUri(s)+"], field v-wf:forWorkItem["+Util.getUri(d)+"], not found",e,"prepare decision form");const p=f["v-wf:isCompleted"];if(p&&!0===p[0].data)return void Util.set_err_on_indv("WorkItem["+Util.getUri(d)+"], already is completed, skip decision form...",e,"prepare decision form");const v=f["v-wf:forProcess"],_=Util.getUri(v),h=get_individual(t,_);if(!h)return void Util.set_err_on_indv("invalid WorkItem["+Util.getUri(d)+"], field v-wf:forProcess["+Util.getUri(v)+"], not found",e,"prepare decision form");const g=h["v-wf:isStopped"];if(g&&!0===g[0].data)return;const m=f["v-wf:forNetElement"],w=get_individual(t,Util.getUri(m));if(!w)return void Util.set_err_on_indv("invalid WorkItem["+Util.getUri(d)+"], field v-wf:forNetElement["+Util.getUri(m)+"], not found",e,"prepare decision form");const U=Util.getUri(w["v-wf:completeDecisionTransform"]);if(!U)return void Util.set_err_on_indv("invalid net_element["+Util.getUri(m)+"], field v-wf:completeDecisionTransform["+U+"], not found",e,"prepare decision form");const y=get_individual(t,U);if(!y)return void Util.set_err_on_indv("invalid net_element["+Util.getUri(m)+"], field v-wf:completeDecisionTransform["+U+"], not found",e,"prepare decision form");const k=Convert.transformation(t,r,y,u,s,v),b=WorkflowUtil.store_items_and_set_minimal_rights(t,k);k.length>0&&(Util.set_field_to_document("v-wf:outVars",b,l["@"]),l["v-wf:outVars"]=b,Util.set_field_to_document("v-wf:isCompleted",Util.newBool(!0),e["@"]),WorkflowUtil.mapToJournal(w["v-wf:completedExecutorJournalMap"],t,h,f,l,null,Util.getJournalUri(l["@"])))}catch(t){print(t.stack)}}function PrepareProcess(t,e){const i=Util$1.hasValue(e,"v-s:deleted");if(Util$1.hasValue(e,"v-wf:isCompleted")||i)return;const r=e,n=WorkflowUtil.get_trace_journal(e,r);n&&Util.traceToJournal(t,n,"prepare_process",e["@"]);const o=r["v-wf:inVars"]||[],a=Util.getUri(e["v-wf:instanceOf"]),s=get_individual(t,a);if(!s)return;const l=s["v-wf:localVariable"];if(l)for(const i of l){const r=get_individual(t,i.data);if(!r)continue;const n=Util.getUri(r["v-wf:varDefineScope"]);if(n&&"v-wf:Net"===n){const i=WorkflowUtil.generate_variable(t,r,null,e,null,null);i&&(put_individual(t,i,_event_id),o.push({data:i["@"],type:"Uri"}))}}const c=[],u=s["v-wf:consistsOf"];if(u)for(const i of u){const r=i.data,o=get_individual(t,r);if(o){if(Util$1.hasValue(o,"rdf:type",{data:"v-wf:InputCondition",type:"Uri"})){const i=WorkflowUtil.create_work_item(t,e["@"],r,null,_event_id,n);c.push({data:i,type:"Uri"});break}}else print("NET ELEMENT UNDFINED:",r)}o.length>0&&(e["v-wf:inVars"]=o),c.length>0&&(e["v-wf:workItemList"]=c),e["v-wf:isCompleted"]=Util.newBool(!1),(o.length>0||c.length>0)&&put_individual(t,e,_event_id)}function PrepareStartForm(t,e){let i,r;if(e["v-wf:processedDocument"]){i=e["v-wf:processedDocument"][0].data,r=e["v-wf:processedDocument"];const n=get_individual(t,i);Util$1.hasValue(n,"rdf:type",{data:"v-wf:DecisionForm",type:"Uri"})&&(i=n["v-wf:onDocument"]?n["v-wf:onDocument"][0].data:n["@"],r=n["v-wf:onDocument"]||[{data:e["@"],type:"Uri"}],e["v-wf:processedDocument"]=r,e["v-wf:hasParentTask"]=[{data:n["@"],type:"Uri"}],n["v-wf:hasChildTask"]=(n["v-wf:hasChildTask"]||[]).concat(Util.newUri(e["@"])),put_individual(t,n,_event_id))}else i=e["@"],r=[{data:e["@"],type:"Uri"}];let n=e["v-wf:isTrace"];n=!(!n||!0!==Util.getFirstValue(n));const o=get_individual(t,e["@"]),a=o["v-wf:hasStatusWorkflow"];if(!a)return;if("v-wf:ToBeSent"!=Util.getUri(a))return void print("[WORKFLOW]:prepare_start_form, not ready to start.");if(o["v-wf:isProcess"])return void print("[WORKFLOW]:prepare_start_form, already started.");Util$1.hasValue(e,"v-wf:processedDocument")&&Util.addToGroup(t,Util.getUri(e["v-wf:processedDocument"]),e["@"],["v-s:canRead"]);const s=Util$1.genUri()+"-prs",l=e["v-s:creator"];let c;if(Util$1.hasValue(e,"v-s:creator")){const i=e["v-s:creator"][0].data,r=get_individual(t,i);Util$1.hasValue(r,"v-s:employee")&&(c=r["v-s:employee"][0].data)}const u=e["v-wf:forNet"],d=get_individual(t,Util.getUri(u));if(!d)return;const f=[],p=Util.getUri(e["v-wf:useTransformation"]);if(print("@js transform_link=",p),p){const i=get_individual(t,p);if(!i)return;const r=Convert.transformation(t,e,i,null,null,Util.newUri(s));for(const e of r)put_individual(t,e,_event_id),f.push({data:e["@"],type:"Uri"})}const v={"@":s,"rdf:type":Util.newUri("v-wf:Process"),"v-wf:instanceOf":u};let _;v["rdfs:label"]=[{data:"  :"+Util.getFirstValue(d["rdfs:label"]),type:"String"}],n&&(v["v-wf:isTrace"]=Util.newBool(!0)),f.length>0&&(v["v-wf:inVars"]=f),v["v-wf:hasStartForm"]=Util.newUri(e["@"]),n&&(_=WorkflowUtil.create_new_journal(t,Util.getTraceJournalUri(s),Util.getJournalUri(i),d["rdfs:label"],!0),_&&(Util.traceToJournal(t,_,"started new process",Util$1.toJson(v)),v["v-wf:traceJournal"]=Util.newUri(_))),put_individual(t,v,_event_id);const h=Util.getJournalUri(i);if(!get_individual(t,h)){const e={"@":h,"rdf:type":Util.newUri("v-s:Journal"),"v-s:onDocument":r,"v-s:created":Util.newDate(new Date)};put_individual(t,e,_event_id)}WorkflowUtil.create_new_journal(t,Util.getJournalUri(s),h,d["rdfs:label"]);const g=Util$1.genUri()+"-psr",m={"@":g,"rdf:type":Util.newUri("v-s:ProcessStarted"),"v-s:processJournal":Util.newUri(Util.getJournalUri(s)),"v-wf:onProcess":Util.newUri(s),"v-s:onDocument":r,"v-s:created":Util.newDate(new Date)};l&&(m["v-s:actor"]=l),put_individual(t,m,_event_id);const w={"@":Util$1.genUri()+"-mbh","rdf:type":Util.newUri("v-s:Membership"),"v-s:resource":Util.newUri(s),"v-s:memberOf":r,"rdfs:comment":Util.newStr("Process is in document group")};put_individual(t,w,_event_id),add_to_individual(t,{"@":i+"j","v-s:childRecord":Util.newUri(g)},_event_id),e["v-wf:hasStatusWorkflow"]=Util.newUri("v-wf:IsSent"),e["v-wf:hasStartForm"]=Util.newUri(e["@"]),e["v-wf:isProcess"]=(e["v-wf:isProcess"]||[]).concat(Util.newUri(s)),put_individual(t,e,_event_id),c&&Util.addRight(t,c,s,["v-s:canRead","v-s:canUpdate","v-s:canDelete"])}Numerator.numerate=function(t,e,i,r,n){try{const i=Util.hasValue(e,"v-s:deleted",{data:!0,type:"Boolean"}),o=r&&Util.hasValue(r,"v-s:deleted",{data:!0,type:"Boolean"});e["rdf:type"]&&e["rdf:type"].length&&e["rdf:type"].forEach((a=>{const s=get_individual(t,a.data);if(!s||!s["v-s:hasNumeration"])return;const l=get_individual(t,s["v-s:hasNumeration"][0].data),c=l["v-s:enumeratedProperty"][0].data;let u=parseInt(e[c]&&e[c].length&&e[c][0].data||0);const d=parseInt(r&&r[c]&&r[c][0].data||0);if(!u||!d||u!==d||i!==o){const o=get_individual(t,l["v-s:hasNumerationRule"][0].data),a=getScope(t,e,o),s=get_individual(t,a)||createScope(t,a);if(u||d){if(!u&&d)e[c]=Util.newStr(d.toString()),put_individual(t,e,n);else if(u&&!r)commitValue(t,s,u,n);else if(u&&i)revokeValue(t,s,u,n);else if(u&&d&&u!==d){commitValue(t,s,u,n);const e=getScope(t,r,o),i=get_individual(t,e);revokeValue(t,i,d,n)}}else u=getNewValue(t,e,o,s),commitValue(t,s,u,n),e[c]=Util.newStr(u.toString()),put_individual(t,e,n)}}))}catch(t){print(t.stack)}},Numerator.getNextValueSimple=function(t,e,i){if("string"==typeof e)try{e=get_individual(t,e)}catch(t){return""+i}if(void 0===e||!e["v-s:numerationCommitedInterval"]||0===e["v-s:numerationCommitedInterval"].length)return""+i;let r=0;return e["v-s:numerationCommitedInterval"].forEach((e=>{const i=e.data;try{(e=get_individual(t,i))["v-s:numerationCommitedIntervalEnd"][0].data>r&&(r=e["v-s:numerationCommitedIntervalEnd"][0].data)}catch(t){print("ERR! intervalUri = ",i),print(t.stack)}})),""+(r+1)};const Workflow={};Workflow.prepare_work_order=PrepareWorkOrder,Workflow.prepare_work_item=PrepareWorkItem,Workflow.prepare_decision_form=PrepareDecisionForm,Workflow.prepare_process=PrepareProcess,Workflow.prepare_start_form=PrepareStartForm,veda$1.Backend=Backend,veda$1.BPMN=BPMN,veda$1.Codelet=Codelet,veda$1.Numerator=Numerator,veda$1.Util={...Util,...Util$1},veda$1.Workflow={...Workflow,...WorkflowUtil};try{veda$1.ticket=get_env_str_var("$ticket"),veda$1.init("cfg:VedaSystem"),console.log("user:",veda$1.user.id,"| ticket:",veda$1.ticket)}catch(t){console.error("Veda init failed")}return veda$1}();
